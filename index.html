<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SynergyChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
    /* SynergyChat - Modern Responsive CSS */

/* CSS Variables for Theme Management */
:root {
  /* Light Theme Colors */
  --primary-bg: #ffffff;
  --secondary-bg: #f8fafc;
  --tertiary-bg: #f1f5f9;
  --chat-bg: #ffffff;
  --sidebar-bg: #f8fafc;
  --message-sent-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --message-received-bg: #e2e8f0;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --accent-color: #3b82f6;
  --accent-hover: #2563eb;
  --success-color: #10b981;
  --error-color: #ef4444;
  --warning-color: #f59e0b;
  --border-color: #e2e8f0;
  --border-hover: #cbd5e1;
  --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.05);
  --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.07);
  --shadow-large: 0 10px 15px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
  --glass-bg: rgba(255, 255, 255, 0.25);
  --glass-border: rgba(255, 255, 255, 0.18);
  --backdrop-blur: blur(16px);
  --header-height: 70px;
  --stories-height: 100px;
  --input-height: 60px;
}

/* Dark Theme Colors */
[data-theme="dark"] {
  --primary-bg: #0f172a;
  --secondary-bg: #1e293b;
  --tertiary-bg: #334155;
  --chat-bg: #1e293b;
  --sidebar-bg: #0f172a;
  --message-sent-bg: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  --message-received-bg: #334155;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  --accent-color: #3b82f6;
  --accent-hover: #2563eb;
  --success-color: #10b981;
  --error-color: #ef4444;
  --warning-color: #f59e0b;
  --border-color: #334155;
  --border-hover: #475569;
  --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.3);
  --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.4);
  --shadow-large: 0 10px 15px rgba(0, 0, 0, 0.5);
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
  --glass-bg: rgba(15, 23, 42, 0.7);
  --glass-border: rgba(255, 255, 255, 0.1);
}

/* Reset and Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--primary-bg);
  color: var(--text-primary);
  line-height: 1.6;
  overflow-x: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: var(--tertiary-bg);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: var(--border-hover);
  border-radius: 3px;
  transition: background 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
  font-weight: 600;
  line-height: 1.4;
  color: var(--text-primary);
}

h1 { font-size: 2rem; }
h2 { font-size: 1.75rem; }
h3 { font-size: 1.5rem; }
h4 { font-size: 1.25rem; }
h5 { font-size: 1.125rem; }
h6 { font-size: 1rem; }

p {
  margin-bottom: 1rem;
}

/* Utility Classes */
.hidden { display: none !important; }
.w-full { width: 100%; }
.text-center { text-align: center; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-center { justify-content: center; }
.space-between { justify-content: space-between; }
.relative { position: relative; }
.absolute { position: absolute; }
.z-10 { z-index: 10; }
.z-20 { z-index: 20; }
.z-30 { z-index: 30; }
.z-40 { z-index: 40; }
.z-50 { z-index: 50; }

/* Main App Container */
#app-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  position: relative;
  background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
}

/* Authentication View */
#auth-view {
  display: none;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  position: relative;
  overflow: hidden;
}

#auth-view::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
  animation: authGradient 10s ease-in-out infinite alternate;
}

@keyframes authGradient {
  0% { opacity: 0.3; }
  100% { opacity: 0.6; }
}

#auth-view.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

.auth-form {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 3rem;
  width: 100%;
  max-width: 420px;
  margin: 2rem;
  box-shadow: var(--shadow-xl);
  position: relative;
  z-index: 10;
  animation: slideInUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.auth-form h2 {
  text-align: center;
  margin-bottom: 2rem;
  color: white;
  font-size: 1.875rem;
  font-weight: 700;
}

.auth-form input {
  width: 100%;
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-size: 1rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.auth-form input::placeholder {
  color: rgba(255, 255, 255, 0.7);
}

.auth-form input:focus {
  outline: none;
  border-color: rgba(255, 255, 255, 0.4);
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.auth-form button {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 16px;
  color: white;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  margin-bottom: 1.5rem;
}

.auth-form button:hover {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.toggle-auth {
  display: block;
  text-align: center;
  color: rgba(255, 255, 255, 0.8);
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.toggle-auth:hover {
  color: white;
  text-decoration: underline;
}

.error-message {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #fca5a5;
  padding: 0.75rem;
  border-radius: 12px;
  margin-bottom: 1rem;
  font-size: 0.875rem;
  backdrop-filter: blur(10px);
}

/* Main App Layout */
#main-app-content-wrapper {
  display: none;
  flex: 1;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

#main-app-content-wrapper.active {
  display: flex;
}

/* Header */
#app-header {
  height: var(--header-height);
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 1.5rem;
  position: sticky;
  top: 0;
  z-index: 40;
  box-shadow: var(--shadow-light);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

#header-title-wrapper {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

#header-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.icon-button {
  width: 44px;
  height: 44px;
  border: none;
  border-radius: 12px;
  background: var(--tertiary-bg);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 1.1rem;
}

.icon-button:hover {
  background: var(--accent-color);
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

.icon-button:active {
  transform: translateY(0);
}

/* User Status Indicator */
.user-status {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--border-color);
  display: inline-block;
  position: relative;
  transition: all 0.3s ease;
}

.user-status.online {
  background: var(--success-color);
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
}

.user-status.online::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: 50%;
  border: 2px solid var(--success-color);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(1.4);
    opacity: 0;
  }
}

/* Stories Rail */
#stories-rail {
  display: flex;
  gap: 1rem;
  padding: 1rem 1.5rem;
  background: var(--secondary-bg);
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

#stories-rail::-webkit-scrollbar {
  display: none;
}

.story-item-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  min-width: 70px;
  cursor: pointer;
}

.story-item, #add-story-placeholder {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-color) 0%, #8b5cf6 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5rem;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.story-item img {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid white;
}

#add-story-placeholder {
  background: var(--tertiary-bg);
  color: var(--text-secondary);
  border: 2px dashed var(--border-color);
}

.story-item:hover, #add-story-placeholder:hover {
  transform: scale(1.1);
  box-shadow: var(--shadow-large);
}

.user-name {
  font-size: 0.75rem;
  color: var(--text-secondary);
  text-align: center;
  font-weight: 500;
  max-width: 70px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Layout Container */
#dynamic-content-area {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* Chat List Views */
#chat-list-view-desktop, #chat-list-view-mobile {
  display: none;
  flex-direction: column;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
}

#chat-list-view-desktop.active, #chat-list-view-mobile.active {
  display: flex;
}

.chat-list-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.5rem;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
  transition: all 0.3s ease;
  position: relative;
}

.chat-list-item:hover {
  background: var(--tertiary-bg);
  transform: translateX(4px);
}

.chat-list-item:last-child {
  border-bottom: none;
}

.chat-list-item .avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-color) 0%, #8b5cf6 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 1.25rem;
  flex-shrink: 0;
  overflow: hidden;
  position: relative;
}

.chat-list-item .avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.chat-info {
  flex: 1;
  min-width: 0;
}

.chat-name-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.25rem;
}

.chat-name {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 1rem;
}

.last-message {
  color: var(--text-secondary);
  font-size: 0.875rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.timestamp {
  color: var(--text-muted);
  font-size: 0.75rem;
  white-space: nowrap;
  align-self: flex-start;
  margin-top: 0.25rem;
}

/* Chat Room View */
#chat-room-view {
  display: none;
  flex-direction: column;
  flex: 1;
  background: var(--chat-bg);
  position: relative;
}

#chat-room-view.active {
  display: flex;
}

#chat-room-header-desktop {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border-color);
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
}

#messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  background: linear-gradient(to bottom, var(--chat-bg) 0%, var(--secondary-bg) 100%);
}

/* Message Bubbles */
.message-bubble {
  max-width: 70%;
  position: relative;
  animation: messageSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  margin-bottom: 0.5rem;
}

@keyframes messageSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.message-bubble.sent {
  align-self: flex-end;
  margin-left: auto;
}

.message-bubble.received {
  align-self: flex-start;
  margin-right: auto;
}

.message-content {
  padding: 1rem 1.25rem;
  border-radius: 20px;
  font-size: 0.95rem;
  line-height: 1.4;
  word-wrap: break-word;
  position: relative;
  backdrop-filter: blur(10px);
  border: 1px solid transparent;
  transition: all 0.3s ease;
}

.message-bubble.sent .message-content {
  background: var(--message-sent-bg);
  color: white;
  border-bottom-right-radius: 8px;
  box-shadow: var(--shadow-medium);
}

.message-bubble.received .message-content {
  background: var(--message-received-bg);
  color: var(--text-primary);
  border-bottom-left-radius: 8px;
  border: 1px solid var(--border-color);
}

.message-content strong {
  font-weight: 700;
}

.message-content em {
  font-style: italic;
}

.message-content code {
  background: rgba(0, 0, 0, 0.1);
  padding: 0.2rem 0.4rem;
  border-radius: 6px;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.85rem;
}

/* Reply Snippet */
.reply-snippet {
  background: rgba(0, 0, 0, 0.1);
  border-left: 3px solid currentColor;
  padding: 0.5rem 0.75rem;
  margin-bottom: 0.5rem;
  border-radius: 8px;
  font-size: 0.8rem;
  opacity: 0.8;
}

.reply-snippet-sender {
  font-weight: 600;
  display: block;
  margin-bottom: 0.2rem;
}

.reply-snippet-text {
  font-style: italic;
}

/* Media Messages */
.media-message {
  max-width: 300px;
  max-height: 300px;
  border-radius: 12px;
  object-fit: cover;
  display: block;
  box-shadow: var(--shadow-medium);
}

.location-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: inherit;
  text-decoration: none;
  padding: 0.5rem;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 8px;
  transition: all 0.3s ease;
}

.location-link:hover {
  background: rgba(0, 0, 0, 0.1);
  transform: translateY(-1px);
}

/* Message Actions & Timestamp */
.message-actions {
  position: absolute;
  top: -15px;
  right: 10px;
  background: var(--primary-bg);
  border-radius: 20px;
  padding: 0.25rem;
  box-shadow: var(--shadow-medium);
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.3s ease;
  border: 1px solid var(--border-color);
}

.message-bubble:hover .message-actions {
  opacity: 1;
  transform: translateY(0);
}

.message-actions button {
  background: none;
  border: none;
  padding: 0.5rem;
  cursor: pointer;
  color: var(--text-secondary);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.message-actions button:hover {
  background: var(--accent-color);
  color: white;
}

.message-bubble .timestamp {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
  text-align: right;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 0.25rem;
}

.message-bubble.received .timestamp {
  text-align: left;
  justify-content: flex-start;
}

/* Typing Indicator */
#typing-indicator {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-style: italic;
  min-height: 1.5rem;
  display: flex;
  align-items: center;
}

/* Reply Preview */
#current-reply-preview {
  background: var(--tertiary-bg);
  border: 1px solid var(--border-color);
  border-radius: 12px 12px 0 0;
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.875rem;
  color: var(--text-secondary);
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#cancel-reply-button {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 50%;
  transition: all 0.3s ease;
}

#cancel-reply-button:hover {
  color: var(--error-color);
  background: rgba(239, 68, 68, 0.1);
}

/* Message Input Area */
#message-input-area {
  display: flex;
  align-items: flex-end;
  gap: 0.75rem;
  padding: 1rem 1.5rem;
  background: var(--primary-bg);
  border-top: 1px solid var(--border-color);
  position: relative;
}

#message-input {
  flex: 1;
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
  resize: none;
  min-height: 44px;
  max-height: 120px;
  background: var(--secondary-bg);
  color: var(--text-primary);
  transition: all 0.3s ease;
  font-family: inherit;
}

#message-input:focus {
  outline: none;
  border-color: var(--accent-color);
  background: var(--primary-bg);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

#message-input::placeholder {
  color: var(--text-muted);
}

#message-input-area .icon-button {
  margin-bottom: 0;
  background: var(--accent-color);
  color: white;
}

#message-input-area .icon-button:hover {
  background: var(--accent-hover);
  transform: scale(1.05);
}

#record-audio-button.recording {
  background: var(--error-color);
  animation: recordingPulse 1s infinite;
}

@keyframes recordingPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* FAB (Floating Action Button) */
#fab-new-chat {
  position: fixed;
  bottom: 3rem;
  right: 2rem;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-color) 0%, #8b5cf6 100%);
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  box-shadow: var(--shadow-large);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  z-index: 30;
}

#fab-new-chat:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: var(--shadow-xl);
}

#fab-new-chat:active {
  transform: scale(0.95);
}

/* Modals */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  z-index: 50;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s ease;
}

.modal.active {
  display: flex;
  opacity: 1;
}

.modal-content {
  background: var(--primary-bg);
  border-radius: 20px;
  box-shadow: var(--shadow-xl);
  position: relative;
  max-width: 90vw;
  max-height: 90vh;
  overflow: hidden;
  animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  border: 1px solid var(--border-color);
}

/* Complete the modalSlideIn keyframe */
@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.8) translateY(50px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

/* User Info Email (Continued) */
.user-info .email {
  font-size: 0.85rem;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* Story Viewer Modal */
#story-viewer-modal .modal-content {
  width: 100%;
  max-width: 600px;
  padding: 0;
  background: var(--primary-bg);
  border-radius: 16px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}

#story-media-display {
  width: 100%;
  max-height: 70vh;
  object-fit: contain;
  display: block;
  border-radius: 16px 16px 0 0;
  background: var(--secondary-bg);
}

#story-viewer-info {
  padding: 1rem 1.5rem;
  width: 100%;
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border-top: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

#story-user-name {
  font-weight: 600;
  font-size: 1rem;
  color: var(--text-primary);
}

#story-timestamp {
  font-size: 0.85rem;
  color: var(--text-muted);
}

#story-viewers-button {
  background: var(--accent-color);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 0.75rem 1.5rem;
  margin: 1rem;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

#story-viewers-button:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

/* Story Viewers Modal */
#story-viewers-modal .modal-content {
  width: 100%;
  max-width: 400px;
  padding: 2rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

#story-viewers-list {
  list-style: none;
  max-height: 50vh;
  overflow-y: auto;
  padding: 0.5rem 0;
}

#story-viewers-list li {
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
  color: var(--text-primary);
  border-bottom: 1px solid var(--border-color);
  transition: background 0.3s ease;
}

#story-viewers-list li:last-child {
  border-bottom: none;
}

#story-viewers-list li:hover {
  background: var(--tertiary-bg);
}

/* Notification Area */
#notification-area {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 60;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.notification {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 0.75rem 1.5rem;
  color: var(--text-primary);
  font-size: 0.9rem;
  box-shadow: var(--shadow-medium);
  animation: notificationSlideIn 0.3s ease, notificationFadeOut 0.3s ease 2.7s;
  max-width: 300px;
}

@keyframes notificationSlideIn {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes notificationFadeOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100%);
  }
}

/* Desktop Layout (768px and above) */
@media (min-width: 768px) {
  #app-container {
    flex-direction: row;
  }

  #chat-list-view-desktop {
    width: 320px;
    flex-shrink: 0;
  }

  #main-app-content-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  #chat-room-header-desktop {
    display: flex !important;
    align-items: center;
    gap: 0.75rem;
  }

  #chat-room-name-desktop {
    font-weight: 600;
    font-size: 1.25rem;
    color: var(--text-primary);
  }

  #chat-room-user-status-text-desktop {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  #back-to-chats-button-mobile {
    display: none !important;
  }

  #stories-rail {
    padding: 1rem;
  }

  .chat-list-item .last-message {
    max-width: 250px;
  }
}

/* Mobile Layout (below 768px) */
@media (max-width: 767px) {
  #chat-list-view-desktop {
    display: none !important;
  }

  #chat-room-header-desktop {
    display: none !important;
  }

  #stories-rail {
    padding: 0.75rem;
  }

  .story-item-wrapper {
    min-width: 60px;
  }

  .story-item, #add-story-placeholder {
    width: 50px;
    height: 50px;
  }

  .story-item img {
    width: 46px;
    height: 46px;
  }

  .user-name {
    font-size: 0.7rem;
  }

  #fab-new-chat {
    bottom: 1.5rem;
    right: 1.5rem;
    width: 50px;
    height: 50px;
    font-size: 1.25rem;
  }

  #message-input-area {
    padding: 0.75rem;
    gap: 0.5rem;
  }

  #message-input {
    min-height: 40px;
    font-size: 0.9rem;
  }

  .icon-button {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }

  .message-bubble {
    max-width: 85%;
  }

  .media-message {
    max-width: 250px;
    max-height: 250px;
  }

  .auth-form {
    padding: 2rem;
    margin: 1rem;
    max-width: 360px;
  }

  .auth-form h2 {
    font-size: 1.5rem;
  }

  .auth-form input {
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
  }

  .auth-form button {
    padding: 0.75rem;
    font-size: 0.9rem;
  }

  .modal-content {
    max-width: 95vw;
    padding: 1.5rem;
  }

  #story-media-display {
    max-height: 60vh;
  }
}

/* Accessibility Enhancements */
@media (prefers-reduced-motion: reduce) {
  * {
    animation: none !important;
    transition: none !important;
  }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
  :root {
    --primary-bg: #ffffff;
    --secondary-bg: #e5e5e5;
    --tertiary-bg: #d0d0d0;
    --chat-bg: #ffffff;
    --sidebar-bg: #e5e5e5;
    --message-sent-bg: #0000ff;
    --message-received-bg: #d0d0d0;
    --text-primary: #000000;
    --text-secondary: #333333;
    --text-muted: #555555;
    --accent-color: #0000ff;
    --accent-hover: #000099;
    --border-color: #000000;
    --border-hover: #333333;
    --glass-bg: transparent;
    --glass-border: #000000;
    --backdrop-blur: none;
  }

  [data-theme="dark"] {
    --primary-bg: #000000;
    --secondary-bg: #333333;
    --tertiary-bg: #555555;
    --chat-bg: #000000;
    --sidebar-bg: #333333;
    --message-sent-bg: #0066ff;
    --message-received-bg: #555555;
    --text-primary: #ffffff;
    --text-secondary: #cccccc;
    --text-muted: #aaaaaa;
    --accent-color: #0066ff;
    --accent-hover: #0033cc;
    --border-color: #ffffff;
    --border-hover: #cccccc;
    --glass-bg: transparent;
    --glass-border: #ffffff;
  }

  .modal {
    background: rgba(0, 0, 0, 0.8);
  }
}

/* File Input Hidden (for accessibility) */
input[type="file"] {
  display: none;
}
</style>
</head>
<body data-theme="light">

    <div id="app-container">
        <div id="auth-view" class="view active">
            <div class="auth-form">
                <div id="login-form">
                    <h2>Welcome Back!</h2>
                    <input type="email" id="login-email" placeholder="Email">
                    <input type="password" id="login-password" placeholder="Password">
                    <button id="login-button" class="w-full">Login</button>
                    <p id="login-error" class="error-message hidden"></p>
                    <span class="toggle-auth" id="show-register">Create an account</span>
                </div>
                <div id="register-form" class="hidden">
                    <h2>Join SynergyChat</h2>
                    <input type="text" id="register-name" placeholder="Display Name">
                    <input type="email" id="register-email" placeholder="Email">
                    <input type="password" id="register-password" placeholder="Password">
                    <button id="register-button" class="w-full">Register</button>
                    <p id="register-error" class="error-message hidden"></p>
                    <span class="toggle-auth" id="show-login">Already have an account? Login</span>
                </div>
            </div>
        </div>
        
        <section id="chat-list-view-desktop" class="view"> 
            </section>

        <div id="main-app-content-wrapper">
            <header id="app-header">
                <div class="header-left">
                    <button id="back-to-chats-button-mobile" class="icon-button hidden">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div id="header-title-wrapper">
                         <h1 id="header-title">SynergyChat</h1>
                         <span id="chat-room-header-status" class="user-status hidden"></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="add-story-button" class="icon-button" title="Add Story"><i class="fas fa-plus-circle"></i></button>
                    <input type="file" id="story-file-input" accept="image/*,video/*">
                    <button id="theme-toggle-button" class="icon-button" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                    <button id="logout-button" class="icon-button" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <section id="stories-rail">
                 <div class="story-item-wrapper">
                    <div id="add-story-placeholder" title="Create Story"><i class="fas fa-plus"></i></div>
                    <span class="user-name">Add Story</span>
                </div>
                </section>
            
            <div id="dynamic-content-area" style="flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;">
                <section id="chat-list-view-mobile" class="view">
                     <p id="no-chats-message" class="text-center hidden" style="padding: 20px;">No active chats. Start a new one!</p>
                </section>

                <section id="chat-room-view" class="view">
                    <div id="chat-room-header-desktop" class="hidden"> <span id="chat-room-name-desktop"></span>
                        <span id="chat-room-user-status-text-desktop"></span>
                     </div>
                    <div id="current-reply-preview" class="hidden">
                        <span>Replying to: <strong>User</strong> "Message snippet..."</span>
                        <button id="cancel-reply-button" title="Cancel Reply"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="messages-container">
                        </div>
                    <div id="typing-indicator"></div>
                    <div id="message-input-area">
                        <input type="file" id="media-file-input" accept="image/*,video/*,audio/*"> <button id="attach-media-button" class="icon-button" title="Attach Media"><i class="fas fa-paperclip"></i></button>
                        <button id="record-audio-button" class="icon-button" title="Record Audio"><i class="fas fa-microphone"></i></button>
                        <button id="send-location-button" class="icon-button" title="Send Location"><i class="fas fa-map-marker-alt"></i></button>
                        <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                        <button id="send-message-button" class="icon-button" title="Send"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </section>
            </div>
        </div>

        <button id="fab-new-chat" title="New Chat"><i class="fas fa-plus"></i></button>

        <div id="new-chat-modal" class="modal">
            <div class="modal-content">
                <button class="modal-close-button icon-button" data-modal-id="new-chat-modal"><i class="fas fa-times"></i></button>
                <h2>Start New Chat</h2>
                <input type="text" id="user-search-input-modal" placeholder="Search users by name or email...">
                <div id="all-users-list">
                    </div>
            </div>
        </div>

        <div id="story-viewer-modal" class="modal">
            <div class="modal-content">
                <button class="modal-close-button icon-button" data-modal-id="story-viewer-modal"><i class="fas fa-times"></i></button>
                <img id="story-media-display" src="" alt="Story Media">
                <div id="story-viewer-info">
                    <p id="story-user-name"></p>
                    <p id="story-timestamp"></p>
                </div>
                <button id="story-viewers-button" class="hidden">View Story Viewers</button>
            </div>
        </div>

        <div id="story-viewers-modal" class="modal">
            <div class="modal-content">
                <button class="modal-close-button icon-button" data-modal-id="story-viewers-modal"><i class="fas fa-times"></i></button>
                <h2>Story Viewers</h2>
                <ul id="story-viewers-list"></ul>
            </div>
        </div>
        
        <div id="notification-area"></div>

    </div> <script type="module">
      // Firebase SDK imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
    onAuthStateChanged, signOut, updateProfile 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { 
    getDatabase, ref, set, get, child, onValue, push, update, remove, 
    serverTimestamp, query, orderByChild, equalTo, limitToLast, onChildAdded, 
    onChildChanged, onChildRemoved, off, goOnline, goOffline, onDisconnect
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyCT7Ih36xNcp3rMgFB17OyleTh-kaeBBZk",
    authDomain: "weightoff-b7916.firebaseapp.com",
    databaseURL: "https://weightoff-b7916-default-rtdb.firebaseio.com",
    projectId: "weightoff-b7916",
    storageBucket: "weightoff-b7916.firebasestorage.app",
    messagingSenderId: "623909660439",
    appId: "1:623909660439:web:29d5305a401c84bfd2b952",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const cloudinaryPreset = "farhadsultan";
const cloudinaryCloudName = "dbiltdpxh";
const cloudinaryUploadURL = `https://api.cloudinary.com/v1_1/${cloudinaryCloudName}/upload`;

// --- Global State ---
let currentUser = null;
let currentChatId = null;
let currentChatOtherUser = null;
let usersCache = {};
let chatListeners = {};
let typingTimeout = null;
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let currentReplyContext = null;
let currentOpenView = 'auth-view';

// --- DOM Elements Cache ---
const dom = {
    authView: document.getElementById('auth-view'),
    loginForm: document.getElementById('login-form'),
    registerForm: document.getElementById('register-form'),
    loginEmail: document.getElementById('login-email'),
    loginPassword: document.getElementById('login-password'),
    loginButton: document.getElementById('login-button'),
    loginError: document.getElementById('login-error'),
    registerName: document.getElementById('register-name'),
    registerEmail: document.getElementById('register-email'),
    registerPassword: document.getElementById('register-password'),
    registerButton: document.getElementById('register-button'),
    registerError: document.getElementById('register-error'),
    showRegister: document.getElementById('show-register'),
    showLogin: document.getElementById('show-login'),
    mainAppContentWrapper: document.getElementById('main-app-content-wrapper'),
    chatListViewDesktop: document.getElementById('chat-list-view-desktop'),
    dynamicContentArea: document.getElementById('dynamic-content-area'),
    appHeader: document.getElementById('app-header'),
    headerTitle: document.getElementById('header-title'),
    chatRoomHeaderStatus: document.getElementById('chat-room-header-status'),
    backToChatsButtonMobile: document.getElementById('back-to-chats-button-mobile'),
    themeToggleButton: document.getElementById('theme-toggle-button'),
    logoutButton: document.getElementById('logout-button'),
    addStoryButton: document.getElementById('add-story-button'),
    storyFileInput: document.getElementById('story-file-input'),
    storiesRail: document.getElementById('stories-rail'),
    addStoryPlaceholder: document.getElementById('add-story-placeholder'),
    chatListViewMobile: document.getElementById('chat-list-view-mobile'),
    noChatsMessage: document.getElementById('no-chats-message'),
    chatRoomView: document.getElementById('chat-room-view'),
    chatRoomHeaderDesktop: document.getElementById('chat-room-header-desktop'),
    chatRoomNameDesktop: document.getElementById('chat-room-name-desktop'),
    chatRoomUserStatusTextDesktop: document.getElementById('chat-room-user-status-text-desktop'),
    messagesContainer: document.getElementById('messages-container'),
    typingIndicator: document.getElementById('typing-indicator'),
    messageInputArea: document.getElementById('message-input-area'),
    messageInput: document.getElementById('message-input'),
    sendMessageButton: document.getElementById('send-message-button'),
    attachMediaButton: document.getElementById('attach-media-button'),
    mediaFileInput: document.getElementById('media-file-input'),
    recordAudioButton: document.getElementById('record-audio-button'),
    sendLocationButton: document.getElementById('send-location-button'),
    currentReplyPreview: document.getElementById('current-reply-preview'),
    cancelReplyButton: document.getElementById('cancel-reply-button'),
    fabNewChat: document.getElementById('fab-new-chat'),
    newChatModal: document.getElementById('new-chat-modal'),
    userSearchInputModal: document.getElementById('user-search-input-modal'),
    allUsersList: document.getElementById('all-users-list'),
    storyViewerModal: document.getElementById('story-viewer-modal'),
    storyMediaDisplay: document.getElementById('story-media-display'),
    storyViewerInfo: document.getElementById('story-viewer-info'),
    storyUserName: document.getElementById('story-user-name'),
    storyTimestamp: document.getElementById('story-timestamp'),
    storyViewersButton: document.getElementById('story-viewers-button'),
    storyViewersModal: document.getElementById('story-viewers-modal'),
    storyViewersList: document.getElementById('story-viewers-list'),
    notificationArea: document.getElementById('notification-area'),
    modalCloseButtons: document.querySelectorAll('.modal-close-button')
};

// --- Utility Functions ---
function showView(viewId) {
    currentOpenView = viewId;
    dom.authView.classList.remove('active');
    dom.mainAppContentWrapper.classList.remove('active');
    dom.chatListViewDesktop.classList.remove('active');
    dom.chatListViewMobile.classList.remove('active');
    dom.chatRoomView.classList.remove('active');
    dom.backToChatsButtonMobile.classList.add('hidden');

    if (viewId === 'auth-view') {
        dom.authView.classList.add('active');
        dom.fabNewChat.classList.add('hidden');
    } else {
        dom.mainAppContentWrapper.classList.add('active');
        dom.fabNewChat.classList.remove('hidden');
        if (window.innerWidth >= 768) {
            dom.chatListViewDesktop.classList.add('active');
            dom.storiesRail.style.display = 'flex';
            dom.fabNewChat.style.display = 'flex';
            if (viewId === 'chat-room-view') {
                dom.chatRoomView.classList.add('active');
                dom.headerTitle.textContent = currentChatOtherUser?.displayName || "Chat";
            } else {
                dom.chatRoomView.classList.remove('active');
                dom.headerTitle.textContent = "SynergyChat";
            }
        } else {
            dom.chatListViewDesktop.classList.remove('active');
            if (viewId === 'chat-list-view-mobile') {
                dom.chatListViewMobile.classList.add('active');
                dom.storiesRail.style.display = 'flex';
                dom.headerTitle.textContent = "SynergyChat";
                dom.fabNewChat.style.display = 'flex';
            } else if (viewId === 'chat-room-view') {
                dom.chatRoomView.classList.add('active');
                dom.storiesRail.style.display = 'none';
                dom.headerTitle.textContent = currentChatOtherUser?.displayName || "Chat";
                dom.backToChatsButtonMobile.classList.remove('hidden');
                dom.fabNewChat.style.display = 'none';
            }
        }
    }
    updateHeaderUserStatus();
}

function displayError(element, message) {
    element.textContent = message;
    element.classList.remove('hidden');
}

function clearError(element) {
    element.textContent = '';
    element.classList.add('hidden');
}

function showNotification(message, duration = 3000) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    dom.notificationArea.appendChild(notification);
    setTimeout(() => notification.remove(), duration);
}

function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatRelativeTime(timestamp) {
    if (!timestamp) return 'unknown';
    const now = new Date();
    const date = new Date(timestamp);
    const diffSeconds = Math.round((now - date) / 1000);
    if (diffSeconds < 5) return 'Online';
    if (diffSeconds < 60) return `${diffSeconds}s ago`;
    const diffMinutes = Math.round(diffSeconds / 60);
    if (diffMinutes < 60) return `${diffMinutes}m ago`;
    const diffHours = Math.round(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    const diffDays = Math.round(diffHours / 24);
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

// --- Theme Toggle ---
function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    dom.themeToggleButton.innerHTML = newTheme === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
}

function applySavedTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    dom.themeToggleButton.innerHTML = savedTheme === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
}

// --- Modal Controls ---
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

dom.modalCloseButtons.forEach(btn => {
    btn.addEventListener('click', () => closeModal(btn.dataset.modalId));
});

// --- Cloudinary Upload ---
async function uploadToCloudinary(fileOrBlob, resourceType = "auto") {
    const formData = new FormData();
    formData.append('file', fileOrBlob);
    formData.append('upload_preset', cloudinaryPreset);
    formData.append('resource_type', resourceType);
    try {
        const response = await fetch(cloudinaryUploadURL, { method: 'POST', body: formData });
        const data = await response.json();
        if (data.secure_url) return data.secure_url;
        throw new Error(data.error?.message || 'Cloudinary upload error');
    } catch (error) {
        console.error('Error uploading to Cloudinary:', error);
        showNotification('Media upload failed. ' + error.message, 5000);
        return null;
    }
}

// --- Authentication & Presence ---
function initPresenceSystem(user) {
    const userStatusRef = ref(db, `users/${user.uid}/status`);
    const presenceRef = ref(db, '.info/connected');
    onValue(presenceRef, (snap) => {
        if (snap.val() === true) {
            set(userStatusRef, { isOnline: true, lastSeen: serverTimestamp() });
            onDisconnect(userStatusRef).set({ isOnline: false, lastSeen: serverTimestamp() });
            goOnline(db);
        }
    });
}

onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            photoURL: user.photoURL
        };
        usersCache[user.uid] = currentUser;
        initPresenceSystem(user);
        showView(window.innerWidth >= 768 ? 'chat-list-view-desktop' : 'chat-list-view-mobile');
        loadUserChats();
        loadStories();
    } else {
        if (currentUser?.uid) goOffline(db);
        currentUser = null;
        showView('auth-view');
        Object.values(chatListeners).forEach(listenerObj => {
            if (listenerObj && typeof listenerObj.unsubscribe === 'function') {
                listenerObj.unsubscribe();
            } else if (typeof listenerObj === 'function') {
                off(listenerObj);
            }
        });
        chatListeners = {};
        dom.chatListViewMobile.innerHTML = '';
        dom.chatListViewDesktop.innerHTML = '';
        dom.storiesRail.innerHTML = `<div class="story-item-wrapper"><div id="add-story-placeholder" title="Create Story"><i class="fas fa-plus"></i></div><span class="user-name">Add Story</span></div>`;
        document.getElementById('add-story-placeholder').addEventListener('click', () => dom.storyFileInput.click());
    }
});

// Authentication Event Listeners
dom.registerButton.addEventListener('click', async () => {
    const name = dom.registerName.value.trim();
    const email = dom.registerEmail.value.trim();
    const password = dom.registerPassword.value.trim();
    clearError(dom.registerError);

    if (!name || !email || !password) {
        displayError(dom.registerError, 'All fields are required.');
        return;
    }

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName: name });
        await set(ref(db, `users/${userCredential.user.uid}`), {
            uid: userCredential.user.uid,
            displayName: name,
            email: email,
            photoURL: '',
            createdAt: serverTimestamp(),
            status: { isOnline: false, lastSeen: serverTimestamp() }
        });
        showNotification('Account created successfully!', 3000);
        showView('chat-list-view-mobile');
    } catch (error) {
        displayError(dom.registerError, error.message);
    }
});

dom.loginButton.addEventListener('click', async () => {
    const email = dom.loginEmail.value.trim();
    const password = dom.loginPassword.value.trim();
    clearError(dom.loginError);

    if (!email || !password) {
        displayError(dom.loginError, 'Email and password are required.');
        return;
    }

    try {
        await signInWithEmailAndPassword(auth, email, password);
        showNotification('Logged in successfully!', 3000);
        showView('chat-list-view-mobile');
    } catch (error) {
        displayError(dom.loginError, error.message);
    }
});

dom.showRegister.addEventListener('click', () => {
    dom.loginForm.classList.add('hidden');
    dom.registerForm.classList.remove('hidden');
});

dom.showLogin.addEventListener('click', () => {
    dom.registerForm.classList.add('hidden');
    dom.loginForm.classList.remove('hidden');
});

dom.logoutButton.addEventListener('click', async () => {
    if (currentUser?.uid) {
        await set(ref(db, `users/${currentUser.uid}/status`), { isOnline: false, lastSeen: serverTimestamp() });
        goOffline(db);
    }
    await signOut(auth);
    showNotification('Logged out successfully!', 3000);
});

// --- User Management ---
async function getUserData(userId) {
    if (usersCache[userId] && usersCache[userId].status) {
        return usersCache[userId];
    }
    try {
        const snapshot = await get(child(ref(db, 'users'), userId));
        if (snapshot.exists()) {
            const userData = snapshot.val();
            usersCache[userId] = userData;
            return userData;
        }
        return { displayName: 'Unknown User', photoURL: '', status: { isOnline: false, lastSeen: 0 } };
    } catch (error) {
        console.error('Error fetching user data:', error);
        return { displayName: 'Error User', photoURL: '', status: { isOnline: false, lastSeen: 0 } };
    }
}

// --- Chat List ---
function renderChatListToDOM(targetElement, chats) {
    targetElement.innerHTML = '';
    if (chats.length === 0) {
        dom.noChatsMessage.classList.remove('hidden');
        targetElement.appendChild(dom.noChatsMessage);
        return;
    }
    dom.noChatsMessage.classList.add('hidden');

    chats.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));

    chats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'chat-list-item';
        item.dataset.chatId = chat.chatId;
        item.dataset.otherUserId = chat.otherUser.uid;

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        if (chat.otherUser.photoURL) {
            const img = document.createElement('img');
            img.src = chat.otherUser.photoURL;
            img.alt = chat.otherUser.displayName?.charAt(0) || '?';
            avatar.appendChild(img);
        } else {
            avatar.textContent = chat.otherUser.displayName?.charAt(0).toUpperCase() || '?';
        }

        const info = document.createElement('div');
        info.className = 'chat-info';

        const nameStatusDiv = document.createElement('div');
        nameStatusDiv.className = 'chat-name-status';
        const name = document.createElement('div');
        name.className = 'chat-name';
        name.textContent = chat.otherUser.displayName || 'User';
        const statusIndicator = document.createElement('span');
        statusIndicator.className = `user-status ${chat.otherUser.status?.isOnline ? 'online' : ''}`;
        statusIndicator.title = chat.otherUser.status?.isOnline ? 'Online' : `Last seen: ${formatRelativeTime(chat.otherUser.status?.lastSeen)}`;
        nameStatusDiv.appendChild(name);
        nameStatusDiv.appendChild(statusIndicator);

        const lastMsg = document.createElement('div');
        lastMsg.className = 'last-message';
        if (chat.lastMessage) {
            let prefix = chat.lastMessage.senderId === currentUser.uid ? "You: " : "";
            if (chat.lastMessage.type === 'image') lastMsg.textContent = prefix + " Image";
            else if (chat.lastMessage.type === 'video') lastMsg.textContent = prefix + " Video";
            else if (chat.lastMessage.type === 'audio') lastMsg.textContent = prefix + " Audio";
            else if (chat.lastMessage.type === 'location') lastMsg.textContent = prefix + " Location";
            else lastMsg.textContent = prefix + (chat.lastMessage.text || 'No messages yet.');
        } else {
            lastMsg.textContent = 'No messages yet.';
        }

        const timestampElem = document.createElement('div');
        timestampElem.className = 'timestamp';
        timestampElem.textContent = chat.lastMessage?.timestamp ? formatTimestamp(chat.lastMessage.timestamp) : '';

        info.appendChild(nameStatusDiv);
        info.appendChild(lastMsg);
        item.appendChild(avatar);
        item.appendChild(info);
        item.appendChild(timestampElem);

        item.addEventListener('click', () => openChat(chat.chatId, chat.otherUser.uid));
        targetElement.appendChild(item);

        const userStatusRef = ref(db, `users/${chat.otherUser.uid}/status`);
        if (chatListeners[`status_${chat.otherUser.uid}`]) off(chatListeners[`status_${chat.otherUser.uid}`]);
        chatListeners[`status_${chat.otherUser.uid}`] = onValue(userStatusRef, (statusSnap) => {
            if (statusSnap.exists()) {
                const statusData = statusSnap.val();
                usersCache[chat.otherUser.uid] = { ...usersCache[chat.otherUser.uid], status: statusData };
                statusIndicator.className = `user-status ${statusData.isOnline ? 'online' : ''}`;
                statusIndicator.title = statusData.isOnline ? 'Online' : `Last seen: ${formatRelativeTime(statusData.lastSeen)}`;
                if (currentChatOtherUser?.uid === chat.otherUser.uid) {
                    currentChatOtherUser.status = statusData;
                    updateHeaderUserStatus();
                }
            }
        });
    });
}

async function loadUserChats() {
    if (!currentUser) return;
    const userChatsRef = ref(db, `userChats/${currentUser.uid}`);
    if (chatListeners['userChats']) off(chatListeners['userChats']);
    chatListeners['userChats'] = onValue(userChatsRef, async (snapshot) => {
        const chatDataPromises = [];
        if (snapshot.exists()) {
            snapshot.forEach(chatSnap => {
                const chatMetaData = chatSnap.val();
                const chatId = chatSnap.key;
                chatDataPromises.push(
                    getUserData(chatMetaData.otherUserId).then(otherUser => ({
                        chatId,
                        otherUser,
                        lastMessage: chatMetaData.lastMessage,
                        pinned: chatMetaData.pinned
                    }))
                );
            });
        }
        const resolvedChats = await Promise.all(chatDataPromises);
        renderChatListToDOM(dom.chatListViewMobile, resolvedChats);
        renderChatListToDOM(dom.chatListViewDesktop, resolvedChats);

        resolvedChats.forEach(chat => {
            const chatMetaRef = ref(db, `chats/${chat.chatId}/lastMessage`);
            if (chatListeners[`lastMsg_${chat.chatId}`]) off(chatListeners[`lastMsg_${chat.chatId}`]);
            chatListeners[`lastMsg_${chat.chatId}`] = onValue(chatMetaRef, (msgSnap) => {
                if (msgSnap.exists()) {
                    loadUserChats();
                }
            });
        });
    }, (error) => console.error("Error loading user chats:", error));
}

// --- New Chat / User Listing ---
dom.fabNewChat.addEventListener('click', async () => {
    openModal('new-chat-modal');
    dom.userSearchInputModal.value = '';
    dom.allUsersList.innerHTML = '<li>Loading users...</li>';

    const usersRef = ref(db, 'users');
    const snapshot = await get(usersRef);
    dom.allUsersList.innerHTML = '';
    if (snapshot.exists()) {
        snapshot.forEach(userSnap => {
            const userData = userSnap.val();
            if (userData.uid !== currentUser.uid) {
                renderUserListItem(userData, dom.allUsersList);
            }
        });
        if (dom.allUsersList.children.length === 0) {
            dom.allUsersList.innerHTML = '<li>No other users found.</li>';
        }
    } else {
        dom.allUsersList.innerHTML = '<li>No users found.</li>';
    }
});

dom.userSearchInputModal.addEventListener('input', (e) => {
    const queryText = e.target.value.trim().toLowerCase();
    const allUserItems = dom.allUsersList.querySelectorAll('.user-result-item');
    allUserItems.forEach(item => {
        const name = item.dataset.userName?.toLowerCase() || '';
        const email = item.dataset.userEmail?.toLowerCase() || '';
        if (name.includes(queryText) || email.includes(queryText)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
});

function renderUserListItem(userData, targetListElement) {
    const div = document.createElement('div');
    div.className = 'user-result-item';
    div.dataset.userId = userData.uid;
    div.dataset.userName = userData.displayName;
    div.dataset.userEmail = userData.email;

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'avatar';
    if (userData.photoURL) {
        const img = document.createElement('img');
        img.src = userData.photoURL;
        avatarDiv.appendChild(img);
    } else {
        avatarDiv.textContent = userData.displayName ? userData.displayName.charAt(0).toUpperCase() : '?';
    }
    div.appendChild(avatarDiv);

    const userInfoDiv = document.createElement('div');
    userInfoDiv.className = 'user-info';
    const nameP = document.createElement('p');
    nameP.className = 'name';
    nameP.textContent = userData.displayName;
    const emailP = document.createElement('p');
    emailP.className = 'email';
    emailP.textContent = userData.email;
    userInfoDiv.appendChild(nameP);
    userInfoDiv.appendChild(emailP);
    div.appendChild(userInfoDiv);

    div.onclick = () => startNewChat(userData.uid);
    targetListElement.appendChild(div);
}

async function startNewChat(otherUserId) {
    if (!currentUser || currentUser.uid === otherUserId) return;
    closeModal('new-chat-modal');

    const chatId = currentUser.uid < otherUserId ? `${currentUser.uid}_${otherUserId}` : `${otherUserId}_${currentUser.uid}`;
    const chatRef = ref(db, `chats/${chatId}`);
    const chatSnapshot = await get(chatRef);

    if (!chatSnapshot.exists()) {
        await set(chatRef, {
            members: { [currentUser.uid]: true, [otherUserId]: true },
            createdAt: serverTimestamp(),
            lastMessage: null
        });
        await set(ref(db, `userChats/${currentUser.uid}/${chatId}`), { otherUserId: otherUserId, lastMessage: null });
        await set(ref(db, `userChats/${otherUserId}/${chatId}`), { otherUserId: currentUser.uid, lastMessage: null });
    }
    openChat(chatId, otherUserId);
}

// --- Chat Room ---
async function openChat(chatId, otherUserId) {
    currentChatId = chatId;
    const otherUserData = await getUserData(otherUserId);
    currentChatOtherUser = otherUserData;
    dom.messagesContainer.innerHTML = '';
    clearReplyContext();
    showView('chat-room-view');
    updateHeaderUserStatus();
    loadMessages(chatId);
    listenForTyping(chatId, otherUserId);
}

function updateHeaderUserStatus() {
    const nameElement = dom.headerTitle;
    const statusElement = dom.chatRoomHeaderStatus;
    const statusTextElement = dom.chatRoomUserStatusTextDesktop;

    if (currentOpenView === 'chat-room-view' && currentChatOtherUser) {
        nameElement.textContent = currentChatOtherUser.displayName || 'Chat';
        if (currentChatOtherUser.status?.isOnline) {
            statusElement.className = 'user-status online';
            statusElement.title = 'Online';
            if (statusTextElement) statusTextElement.textContent = 'Online';
        } else {
            statusElement.className = 'user-status';
            const lastSeenText = `Last seen: ${formatRelativeTime(currentChatOtherUser.status?.lastSeen)}`;
            statusElement.title = lastSeenText;
            if (statusTextElement) statusTextElement.textContent = lastSeenText;
        }
        statusElement.classList.remove('hidden');
    } else {
        statusElement.classList.add('hidden');
        if (statusTextElement) statusTextElement.textContent = '';
        if (currentOpenView !== 'auth-view') dom.headerTitle.textContent = "SynergyChat";
    }
}

dom.backToChatsButtonMobile.addEventListener('click', () => {
    showView('chat-list-view-mobile');
    if (currentChatId && chatListeners[currentChatId]) {
        chatListeners[currentChatId].unsubscribe();
        delete chatListeners[currentChatId];
    }
    if (currentChatId && chatListeners[`typing_${currentChatId}`]) {
        off(chatListeners[`typing_${currentChatId}`]);
        delete chatListeners[`typing_${currentChatId}`];
        if (currentUser) set(ref(db, `typing/${currentChatId}/${currentUser.uid}`), false);
    }
    currentChatId = null;
    currentChatOtherUser = null;
    updateHeaderUserStatus();
});

dom.messageInput.addEventListener('input', () => {
    dom.messageInput.style.height = 'auto';
    dom.messageInput.style.height = (dom.messageInput.scrollHeight) + 'px';
    if (currentChatId && currentUser) {
        const typingRef = ref(db, `typing/${currentChatId}/${currentUser.uid}`);
        set(typingRef, true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => { set(typingRef, false); }, 2000);
    }
});

function loadMessages(chatId) {
    const messagesQuery = query(ref(db, `messages/${chatId}`), limitToLast(50));
    if (chatListeners[chatId]) chatListeners[chatId].unsubscribe();
    let listener = onChildAdded(messagesQuery, async (snapshot) => {
        const messageData = snapshot.val();
        messageData.id = snapshot.key;
        if (messageData.senderId !== currentUser.uid && !messageData.seenBy?.[currentUser.uid]) {
            update(ref(db, `messages/${chatId}/${messageData.id}/seenBy`), { [currentUser.uid]: serverTimestamp() });
        }
        renderMessage(messageData);
    });
    chatListeners[chatId] = { unsubscribe: () => off(messagesQuery, 'child_added', listener) };
}

function parseMarkdown(text) {
    if (!text) return '';
    return text
        .replace(/\*(.*?)\*/g, '<strong>$1</strong>')
        .replace(/_(.*?)_/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>');
}

function renderMessage(messageData, isNew = true) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message-bubble';
    msgDiv.classList.add(messageData.senderId === currentUser.uid ? 'sent' : 'received');
    msgDiv.dataset.messageId = messageData.id;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    if (messageData.replyToMessageId && messageData.replyToMessageTextPreview) {
        const replySnippet = document.createElement('div');
        replySnippet.className = 'reply-snippet';
        const replySender = document.createElement('span');
        replySender.className = 'reply-snippet-sender';
        const senderName = messageData.replyToSenderName || (messageData.senderId === currentUser.uid ? "You" : currentChatOtherUser?.displayName || "User");
        replySender.textContent = `Replying to ${senderName}`;
        const replyText = document.createElement('span');
        replyText.className = 'reply-snippet-text';
        replyText.textContent = messageData.replyToMessageTextPreview;
        replySnippet.appendChild(replySender);
        replySnippet.appendChild(replyText);
        contentDiv.appendChild(replySnippet);
    }

    if (messageData.type === 'image' && messageData.mediaUrl) {
        const img = document.createElement('img');
        img.src = messageData.mediaUrl;
        img.className = 'media-message';
        contentDiv.appendChild(img);
    } else if (messageData.type === 'video' && messageData.mediaUrl) {
        const video = document.createElement('video');
        video.src = messageData.mediaUrl;
        video.controls = true;
        video.className = 'media-message';
        contentDiv.appendChild(video);
    } else if (messageData.type === 'audio' && messageData.mediaUrl) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = messageData.mediaUrl;
        contentDiv.appendChild(audio);
    } else if (messageData.type === 'location' && messageData.coordinates) {
        const locLink = document.createElement('a');
        locLink.className = 'location-link';
        locLink.href = `https://maps.google.com/?q=${messageData.coordinates.latitude},${messageData.coordinates.longitude}`;
        locLink.target = '_blank';
        locLink.innerHTML = `<i class="fas fa-map-marked-alt"></i> View Location (${messageData.text || 'Shared Location'})`;
        contentDiv.appendChild(locLink);
    } else {
        contentDiv.innerHTML = parseMarkdown(messageData.text);
    }

    const timeDiv = document.createElement('div');
    timeDiv.className = 'timestamp';
    timeDiv.textContent = formatTimestamp(messageData.timestamp);

    if (messageData.senderId === currentUser.uid) {
        const seenIcon = document.createElement('i');
        seenIcon.style.marginLeft = '5px';
        seenIcon.style.opacity = '0.7';
        if (messageData.seenBy && Object.keys(messageData.seenBy).includes(currentChatOtherUser?.uid)) {
            seenIcon.className = 'fas fa-check-double';
            seenIcon.style.color = 'var(--accent-color)';
        } else {
            seenIcon.className = 'fas fa-check';
        }
        timeDiv.appendChild(seenIcon);
    }

    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';
    const replyBtn = document.createElement('button');
    replyBtn.innerHTML = '<i class="fas fa-reply"></i>';
    replyBtn.title = "Reply";
    replyBtn.onclick = () => setReplyContext(messageData.id, messageData.senderId, messageData.text || messageData.type);
    actionsDiv.appendChild(replyBtn);

    msgDiv.appendChild(contentDiv);
    msgDiv.appendChild(timeDiv);
    msgDiv.appendChild(actionsDiv);
    dom.messagesContainer.appendChild(msgDiv);
    if (isNew) dom.messagesContainer.scrollTop = dom.messagesContainer.scrollHeight;
}

// --- Message Sending ---
dom.sendMessageButton.addEventListener('click', () => sendMessage());
dom.messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

async function sendMessage(textOverride = null, type = 'text', mediaUrl = null, coordinates = null) {
    const text = textOverride !== null ? textOverride : dom.messageInput.value.trim();
    if ((type === 'text' && !text && !currentReplyContext) ||
        ((type === 'image' || type === 'video' || type === 'audio') && !mediaUrl) ||
        (type === 'location' && !coordinates)) {
        if (!text && type === 'text' && currentReplyContext && (currentReplyContext.textPreview.startsWith('') || currentReplyContext.textPreview.startsWith('') || currentReplyContext.textPreview.startsWith('') || currentReplyContext.textPreview.startsWith(''))) {
            // Allow sending if replying to media
        } else {
            return;
        }
    }
    if (!currentUser || !currentChatId) return;

    const messageData = {
        senderId: currentUser.uid,
        text: text,
        type: type,
        mediaUrl: mediaUrl,
        coordinates: coordinates,
        timestamp: serverTimestamp(),
        seenBy: {},
        deliveredTo: {}
    };

    if (currentReplyContext) {
        messageData.replyToMessageId = currentReplyContext.messageId;
        messageData.replyToMessageTextPreview = currentReplyContext.textPreview;
        messageData.replyToSenderName = currentReplyContext.senderName;
    }

    const newMessageRef = push(ref(db, `messages/${currentChatId}`));
    await set(newMessageRef, messageData);

    const lastMessageText =
        type === 'image' ? ' Image' :
        type === 'video' ? ' Video' :
        type === 'audio' ? ' Audio' :
        type === 'location' ? ` ${text || 'Location'}` : text;

    const lastMsgUpdate = { text: lastMessageText, senderId: currentUser.uid, timestamp: serverTimestamp(), type: type };
    await update(ref(db, `chats/${currentChatId}`), { lastMessage: lastMsgUpdate });
    await update(ref(db, `userChats/${currentUser.uid}/${currentChatId}`), { lastMessage: lastMsgUpdate });
    if (currentChatOtherUser) {
        await update(ref(db, `userChats/${currentChatOtherUser.uid}/${currentChatId}`), { lastMessage: lastMsgUpdate });
    }

    if (textOverride === null) dom.messageInput.value = '';
    dom.messageInput.style.height = 'auto';
    set(ref(db, `typing/${currentChatId}/${currentUser.uid}`), false);
    clearReplyContext();
}

// --- Reply Functionality ---
async function setReplyContext(messageId, senderId, textPreview) {
    const originalSender = await getUserData(senderId);
    currentReplyContext = {
        messageId,
        senderName: originalSender.displayName || "User",
        textPreview: textPreview.length > 50 ? textPreview.substring(0, 47) + "..." : textPreview
    };
    dom.currentReplyPreview.querySelector('span').innerHTML = `Replying to: <strong>${currentReplyContext.senderName}</strong> "${currentReplyContext.textPreview}"`;
    dom.currentReplyPreview.classList.remove('hidden');
    dom.messageInput.focus();
}

function clearReplyContext() {
    currentReplyContext = null;
    dom.currentReplyPreview.classList.add('hidden');
}

dom.cancelReplyButton.addEventListener('click', clearReplyContext);

// --- Media & Location ---
dom.attachMediaButton.addEventListener('click', () => dom.mediaFileInput.click());
dom.mediaFileInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    showNotification('Uploading media...', 2000);
    const mediaType = file.type.startsWith('image/') ? 'image' : file.type.startsWith('video/') ? 'video' : 'auto';
    const mediaUrl = await uploadToCloudinary(file, mediaType);
    if (mediaUrl) {
        sendMessage("Media", mediaType, mediaUrl);
    }
});

dom.recordAudioButton.addEventListener('click', async () => {
    if (!isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                audioChunks = [];
                stream.getTracks().forEach(track => track.stop());
                showNotification('Uploading audio...', 2000);
                const audioUrl = await uploadToCloudinary(audioBlob, "video");
                if (audioUrl) {
                    sendMessage(" Voice Message", 'audio', audioUrl);
                } else {
                    showNotification('Audio upload failed.', 3000);
                }
            };
            mediaRecorder.start();
            isRecording = true;
            dom.recordAudioButton.classList.add('recording');
            dom.recordAudioButton.innerHTML = '<i class="fas fa-stop-circle"></i>';
            showNotification('Recording audio...', 5000);
        } catch (err) {
            console.error("Audio recording error:", err);
            showNotification('Could not start audio recording. Check permissions.', 4000);
        }
    } else {
        mediaRecorder.stop();
        isRecording = false;
        dom.recordAudioButton.classList.remove('recording');
        dom.recordAudioButton.innerHTML = '<i class="fas fa-microphone"></i>';
    }
});

dom.sendLocationButton.addEventListener('click', () => {
    if (navigator.geolocation) {
        showNotification('Getting location...', 2000);
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const coords = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                sendMessage(`My current location`, 'location', null, coords);
            },
            (error) => {
                console.error("Geolocation error:", error);
                showNotification('Could not get location: ' + error.message, 4000);
            },
            { enableHighAccuracy: true }
        );
    } else {
        showNotification('Geolocation is not supported by your browser.', 3000);
    }
});

// --- Stories ---
dom.addStoryButton.addEventListener('click', () => dom.storyFileInput.click());
dom.addStoryPlaceholder.addEventListener('click', () => dom.storyFileInput.click());

async function loadStories() {
    const storiesRef = ref(db, 'stories');
    const snapshot = await get(storiesRef);
    dom.storiesRail.innerHTML = `<div class="story-item-wrapper"><div id="add-story-placeholder" title="Create Story"><i class="fas fa-plus"></i></div><span class="user-name">Add Story</span></div>`;
    document.getElementById('add-story-placeholder').addEventListener('click', () => dom.storyFileInput.click());
    if (snapshot.exists()) {
        snapshot.forEach(storySnap => {
            const storyData = storySnap.val();
            if (new Date().getTime() - storyData.timestamp < 24 * 60 * 60 * 1000) {
                renderStoryItem(storyData);
            }
        });
    }
}

function renderStoryItem(storyData) {
    const storyItem = document.createElement('div');
    storyItem.className = 'story-item-wrapper';
    const storyDiv = document.createElement('div');
    storyDiv.className = 'story-item';
    if (storyData.userPhotoURL) {
        const img = document.createElement('img');
        img.src = storyData.userPhotoURL;
        storyDiv.appendChild(img);
    } else {
        storyDiv.textContent = storyData.userDisplayName?.charAt(0).toUpperCase() || '?';
    }
    storyDiv.addEventListener('click', () => viewStory(storyData));
    const nameSpan = document.createElement('span');
    nameSpan.className = 'user-name';
    nameSpan.textContent = storyData.userDisplayName || 'User';
    storyItem.appendChild(storyDiv);
    storyItem.appendChild(nameSpan);
    dom.storiesRail.appendChild(storyItem);
}

async function viewStory(storyData) {
    openModal('story-viewer-modal');
    dom.storyMediaDisplay.src = storyData.mediaUrl;
    dom.storyUserName.textContent = storyData.userDisplayName || 'User';
    dom.storyTimestamp.textContent = formatTimestamp(storyData.timestamp);
    if (storyData.userId === currentUser.uid) {
        dom.storyViewersButton.classList.remove('hidden');
        dom.storyViewersButton.onclick = () => showStoryViewers(storyData.id);
    } else {
        dom.storyViewersButton.classList.add('hidden');
    }
}

async function showStoryViewers(storyId) {
    openModal('story-viewers-modal');
    dom.storyViewersList.innerHTML = '';
    const viewersRef = ref(db, `stories/${storyId}/viewers`);
    const snapshot = await get(viewersRef);
    if (snapshot.exists()) {
        const viewerPromises = Object.keys(snapshot.val()).map(async (uid) => {
            const userData = await getUserData(uid);
            return `<li>${userData.displayName || 'User'}</li>`;
        });
        const viewerList = await Promise.all(viewerPromises);
        dom.storyViewersList.innerHTML = viewerList.join('');
    } else {
        dom.storyViewersList.innerHTML = '<li>No viewers yet.</li>';
    }
}

dom.storyFileInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    showNotification('Uploading story...', 2000);
    const mediaType = file.type.startsWith('image/') ? 'image' : 'video';
    const mediaUrl = await uploadToCloudinary(file, mediaType);
    if (mediaUrl) {
        const storyRef = push(ref(db, 'stories'));
        await set(storyRef, {
            id: storyRef.key,
            userId: currentUser.uid,
            userDisplayName: currentUser.displayName,
            userPhotoURL: currentUser.photoURL,
            mediaUrl: mediaUrl,
            mediaType: mediaType,
            timestamp: serverTimestamp(),
            viewers: {}
        });
        showNotification('Story uploaded!', 3000);
        loadStories();
    }
});

// --- Typing Indicator ---
function listenForTyping(chatId, otherUserId) {
    const typingRef = ref(db, `typing/${chatId}/${otherUserId}`);
    if (chatListeners[`typing_${chatId}`]) off(chatListeners[`typing_${chatId}`]);
    chatListeners[`typing_${chatId}`] = onValue(typingRef, (snap) => {
        if (snap.exists() && snap.val()) {
            dom.typingIndicator.textContent = `${currentChatOtherUser?.displayName || 'User'} is typing...`;
        } else {
            dom.typingIndicator.textContent = '';
        }
    });
}

// --- Initial Setup ---
function initApp() {
    applySavedTheme();
    dom.themeToggleButton.addEventListener('click', toggleTheme);
}

document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
