
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Veritas - Hacker Simulation</title>
    <style>
        /* CSS - Dark Matrix Theme & Styles */
        :root {
            --primary-color: #00FF41; /* Neon Green */
            --background-color: #0A0A0A;
            --text-color: #E0E0E0;
            --container-bg: #1A1A1A;
            --input-bg: #0F0F0F;
            --border-color: #00FF41;
            --error-color: #FF4136;
            --success-color: #3D9970;
            --glitch-color1: #FF00FF;
            --glitch-color2: #00FFFF;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            flex-direction: column;
        }

        .hidden {
            display: none !important;
        }

        /* --- Login/Register Terminal --- */
        #auth-container {
            background-color: var(--container-bg);
            padding: 30px 40px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px var(--border-color);
            width: 350px;
            text-align: center;
            animation: fadeIn 1s ease-in-out;
        }

        #auth-container h2 {
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 25px;
            animation: textGlitch 5s infinite alternate;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-color);
            font-size: 0.9em;
        }

        .input-group input {
            width: calc(100% - 20px);
            padding: 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--primary-color);
            color: var(--text-color);
            outline: none;
            transition: box-shadow 0.3s ease;
        }

        .input-group input:focus {
            box-shadow: 0 0 10px var(--primary-color);
        }

        .auth-buttons button {
            background-color: var(--primary-color);
            color: var(--background-color);
            border: none;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
        }

        .auth-buttons button:hover {
            background-color: var(--text-color);
            color: var(--background-color);
            transform: scale(1.05);
        }

        #auth-message, #login-message, #register-message {
            margin-top: 15px;
            font-size: 0.9em;
            min-height: 1.2em;
            color: var(--error-color);
        }

        #login-message.success, #register-message.success {
            color: var(--success-color);
        }

        .toggle-auth {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9em;
            display: block;
            margin-top: 15px;
        }

        .toggle-auth:hover {
            text-shadow: 0 0 5px var(--primary-color);
        }

        /* --- Game Container --- */
        #game-container {
            width: 90%;
            max-width: 1000px;
            background-color: var(--container-bg);
            border: 1px solid var(--primary-color);
            padding: 20px;
            box-shadow: 0 0 15px var(--primary-color);
            animation: fadeIn 0.5s ease-out;
            position: relative;
        }

        #mission-header {
            text-align: center;
            margin-bottom: 20px;
        }

        #mission-title {
            color: var(--primary-color);
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        #mission-brief {
            font-size: 0.9em;
            color: var(--text-color);
        }

        .game-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed rgba(0, 255, 65, 0.3);
        }

        .game-section h3 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 5px;
        }

        #code-editor {
            width: calc(100% - 22px);
            height: 250px;
            background-color: var(--input-bg);
            border: 1px solid var(--primary-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            font-size: 1em;
            padding: 10px;
            resize: vertical;
        }

        #code-editor:focus {
            outline: none;
            box-shadow: 0 0 10px var(--primary-color);
        }

        #output-section pre {
            background-color: var(--input-bg);
            padding: 10px;
            border: 1px solid var(--primary-color);
            min-height: 50px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-color);
        }

        #game-controls button, #utility-controls button {
            background-color: var(--primary-color);
            color: var(--background-color);
            border: none;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
        }

        #game-controls button:hover, #utility-controls button:hover {
            background-color: var(--text-color);
            color: var(--background-color);
            transform: scale(1.05);
        }

        #timer-section {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.2em;
            color: var(--primary-color);
        }

        #feedback-section p {
            font-style: italic;
        }

        #user-info {
            position: fixed;
            top: 10px;
            left: 10px;
            font-size: 0.8em;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 3px;
            color: var(--primary-color);
            z-index: 100;
        }

        #user-info button {
            margin-left: 10px;
            background: var(--primary-color);
            color: var(--background-color);
            border: none;
            padding: 3px 6px;
            cursor: pointer;
        }

        /* --- Result Screen (Modal) --- */
        #result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }

        #result-content {
            background-color: var(--container-bg);
            padding: 30px 40px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 30px var(--primary-color);
            width: 60%;
            max-width: 600px;
            text-align: center;
            animation: slideInFromTop 0.5s;
        }

        #result-content h2 {
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 10px;
            animation: textGlitch 4s infinite alternate;
        }

        #result-message {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        #result-score, #result-time, #result-quality {
            margin-bottom: 10px;
        }

        #result-content button {
            margin-top: 20px;
            background-color: var(--primary-color);
            color: var(--background-color);
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            font-size: 1em;
        }

        #result-content button:hover {
            background-color: var(--text-color);
            color: var(--background-color);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes textGlitch {
            0% { text-shadow: 0 0 2px var(--primary-color); }
            20% { text-shadow: 2px 2px 2px var(--glitch-color1), -2px -2px 2px var(--glitch-color2); }
            22% { text-shadow: 0 0 2px var(--primary-color); }
            60% { text-shadow: -2px 2px 2px var(--glitch-color2), 2px -2px 2px var(--glitch-color1); }
            62% { text-shadow: 0 0 2px var(--primary-color); }
            100% { text-shadow: 0 0 2px var(--primary-color); }
        }

        /* Matrix Rain Canvas */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #auth-container {
                width: 85%;
                padding: 20px;
            }
            #game-container {
                width: 95%;
                padding: 15px;
            }
            #code-editor {
                height: 200px;
            }
            #timer-section {
                position: static;
                text-align: right;
                margin-bottom: 10px;
            }
            #result-content {
                width: 85%;
            }
        }
    </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>

    <div id="user-info" class="hidden">
        Logged in as: <span id="user-email-display"></span>
        <button id="logout-button">Logout</button>
    </div>

    <div id="auth-container">
        <div id="login-view">
            <h2>System Access</h2>
            <div class="input-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="input-group">
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" required>
            </div>
            <div class="auth-buttons">
                <button id="login-button">Login</button>
            </div>
            <p id="login-message"></p>
            <span class="toggle-auth" onclick="toggleAuthView(false)">Need an account? Register</span>
        </div>

        <div id="register-view" class="hidden">
            <h2>New Agent Registration</h2>
            <div class="input-group">
                <label for="register-email">Email:</label>
                <input type="email" id="register-email" required>
            </div>
            <div class="input-group">
                <label for="register-password">Password:</label>
                <input type="password" id="register-password" required>
            </div>
            <div class="input-group">
                <label for="register-confirm-password">Confirm Password:</label>
                <input type="password" id="register-confirm-password" required>
            </div>
            <div class="auth-buttons">
                <button id="register-button">Register</button>
            </div>
            <p id="register-message"></p>
            <span class="toggle-auth" onclick="toggleAuthView(true)">Already have access? Login</span>
        </div>
    </div>

    <div id="game-container" class="hidden">
        <div id="timer-section">Time Left: <span id="time-display">03:00</span></div>
        
        <div id="mission-header">
            <h2 id="mission-title">Mission: Null Pointer</h2>
            <p id="mission-brief">Initializing first challenge...</p>
        </div>

        <div class="game-section" id="problem-description-section">
            <h3>Problem Description</h3>
            <p id="problem-text"></p>
        </div>

        <div class="game-section" id="code-editor-section">
            <h3>Code Editor</h3>
            <textarea id="code-editor" placeholder="Enter your JavaScript code here..."></textarea>
        </div>

        <div class="game-section" id="output-section">
            <h3>Output / Test Results</h3>
            <pre id="output-area">Awaiting execution...</pre>
        </div>

        <div class="game-section" id="feedback-section">
            <h3>Intel & Feedback</h3>
            <p id="code-feedback">No feedback yet. Compile and run your code.</p>
        </div>
        
        <div id="game-controls" style="text-align: center;">
            <button id="submit-code-button">Execute & Submit</button>
            <button id="reset-code-button">Reset Code</button>
            <button id="hint-button">Request Hint</button>
        </div>
        <div id="utility-controls" style="text-align: right; margin-top:10px;">
            <button id="next-level-button" class="hidden">Proceed to Next Mission</button>
        </div>
    </div>

    <div id="result-modal" class="hidden">
        <div id="result-content">
            <h2 id="result-title">Mission Result</h2>
            <p id="result-message"></p>
            <p id="result-score">Score: <span id="score-value">0</span></p>
            <p id="result-time">Time Used: <span id="time-value">0s</span></p>
            <p id="result-quality">Code Quality: <span id="quality-value">Pending</span></p>
            <button id="close-result-modal-button">Acknowledge</button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports (updated to version 10.14.0)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            get,
            child
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDhLuMymmJPkmMQKvYX8Ma94VAG-uf1kOk",
            authDomain: "test-463d2.firebaseapp.com",
            databaseURL: "https://test-463d2-default-rtdb.firebaseio.com",
            projectId: "test-463d2",
            storageBucket: "test-463d2.firebasestorage.app",
            messagingSenderId: "793933331185",
            appId: "1:793933331185:web:304e16633345f88fc7c750"
        };

        // Initialize Firebase with error handling
        let app;
        let auth;
        let database;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            database = getDatabase(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            const authContainer = document.getElementById('auth-container');
            const loginMessage = document.getElementById('login-message');
            if (authContainer && !authContainer.classList.contains('hidden') && loginMessage) {
                loginMessage.textContent = "CRITICAL ERROR: Could not initialize Firebase. Ensure Email/Password Authentication is enabled in Firebase Console.";
                loginMessage.classList.add('error');
            } else if (document.body) {
                document.body.innerHTML = `<p style="color:red; font-size:18px; text-align:center; margin-top: 50px;">
                    CRITICAL ERROR: Could not initialize Firebase. Please ensure your Firebase project
                    (Project ID: ${firebaseConfig.projectId || 'unknown'}) is correctly configured and
                    Email/Password Authentication is enabled in the Firebase Console.
                    Check the browser console (F12) for details. Error: ${error.message}
                    </p>`;
            }
            throw error; // Stop execution if Firebase fails to initialize
        }

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const gameContainer = document.getElementById('game-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const logoutButton = document.getElementById('logout-button');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const registerConfirmPasswordInput = document.getElementById('register-confirm-password');
        const loginMessage = document.getElementById('login-message');
        const registerMessage = document.getElementById('register-message');
        const userInfoDisplay = document.getElementById('user-info');
        const userEmailDisplay = document.getElementById('user-email-display');

        const missionTitle = document.getElementById('mission-title');
        const missionBrief = document.getElementById('mission-brief');
        const problemText = document.getElementById('problem-text');
        const codeEditor = document.getElementById('code-editor');
        const outputArea = document.getElementById('output-area');
        const codeFeedback = document.getElementById('code-feedback');
        const submitCodeButton = document.getElementById('submit-code-button');
        const resetCodeButton = document.getElementById('reset-code-button');
        const hintButton = document.getElementById('hint-button');
        const nextLevelButton = document.getElementById('next-level-button');
        
        const timeDisplay = document.getElementById('time-display');
        
        const resultModal = document.getElementById('result-modal');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const scoreValue = document.getElementById('score-value');
        const timeValue = document.getElementById('time-value');
        const qualityValue = document.getElementById('quality-value');
        const closeResultModalButton = document.getElementById('close-result-modal-button');

        let currentUser = null;
        let currentLevel = 0;
        let levelTimerInterval;
        let timeLeft = 180;
        let allTestsPassedLastSubmission = false;

        const levels = [
            { 
                title: "Mission: String Reversal Protocol",
                brief: "A critical data packet has been intercepted in reverse order. We need you to write a script to flip it back.",
                problem: "Write a JavaScript function called `reverseString` that takes one argument, a string, and returns that string reversed.",
                template: `function reverseString(str) {\n  // Your code here\n\n  return "";\n}`,
                testCases: [
                    { input: "hello", expected: "olleh" },
                    { input: "world", expected: "dlrow" },
                    { input: "JavaScript", expected: "tpircSavaJ" },
                    { input: "", expected: "" },
                    { input: "a", expected: "a" }
                ],
                hint: "Consider using string methods like split(), reverse(), and join(), or iterate through the string."
            },
            { 
                title: "Mission: Array Summation",
                brief: "Calculate the sum of elements in a data array.",
                problem: "Write a function `sumArray(arr)` that returns the sum of all numbers in an array `arr`.",
                template: `function sumArray(arr) {\n  // Your code here\n\n  return 0;\n}`,
                testCases: [
                    { input: [1, 2, 3], expected: 6 },
                    { input: [10, -2, 5], expected: 13 },
                    { input: [], expected: 0 }
                ],
                hint: "A loop or the reduce() method can be helpful here."
            }
        ];

        window.toggleAuthView = (showLogin) => {
            loginView.classList.toggle('hidden', !showLogin);
            registerView.classList.toggle('hidden', showLogin);
            loginMessage.textContent = '';
            registerMessage.textContent = '';
        };

        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            if (!email || !password) {
                loginMessage.textContent = 'Please enter both email and password.';
                loginMessage.classList.add('error');
                return;
            }
            loginMessage.textContent = 'Attempting login...';
            loginMessage.classList.remove('success', 'error');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginMessage.textContent = 'Login successful! Initializing system...';
                loginMessage.classList.add('success');
            } catch (error) {
                loginMessage.textContent = `Error: ${error.message} (${error.code})`;
                loginMessage.classList.add('error');
                console.error("Login error:", error);
            }
        });

        registerButton.addEventListener('click', async () => {
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value;
            const confirmPassword = registerConfirmPasswordInput.value;
            registerMessage.textContent = 'Processing registration...';
            registerMessage.classList.remove('success', 'error');

            if (!email || !password || !confirmPassword) {
                registerMessage.textContent = 'All fields are required.';
                registerMessage.classList.add('error');
                return;
            }
            if (password !== confirmPassword) {
                registerMessage.textContent = 'Passwords do not match.';
                registerMessage.classList.add('error');
                return;
            }
            if (password.length < 6) {
                registerMessage.textContent = 'Password should be at least 6 characters.';
                registerMessage.classList.add('error');
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                registerMessage.textContent = 'Registration successful! Please login.';
                registerMessage.classList.add('success');
                toggleAuthView(true);
            } catch (error) {
                registerMessage.textContent = `Error: ${error.message} (${error.code})`;
                registerMessage.classList.add('error');
                console.error("Registration error:", error);
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                userInfoDisplay.classList.add('hidden');
                authContainer.classList.remove('hidden');
                gameContainer.classList.add('hidden');
            } catch (error) {
                console.error("Logout error:", error);
                alert("Error logging out.");
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userEmailDisplay.textContent = user.email;
                userInfoDisplay.classList.remove('hidden');
                authContainer.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                await loadUserProgress();
                loadLevel(currentLevel);
            } else {
                currentUser = null;
                userInfoDisplay.classList.add('hidden');
                authContainer.classList.remove('hidden');
                gameContainer.classList.add('hidden');
                loadLocalProgress();
            }
        });

        function loadLevel(levelIndex) {
            if (levelIndex >= levels.length) {
                displayGameComplete();
                return;
            }
            currentLevel = levelIndex;
            const levelData = levels[levelIndex];
            missionTitle.textContent = levelData.title;
            missionBrief.textContent = levelData.brief;
            problemText.textContent = levelData.problem;
            codeEditor.value = levelData.template;
            outputArea.textContent = 'Awaiting execution...';
            codeFeedback.textContent = 'No feedback yet.';
            nextLevelButton.classList.add('hidden');
            allTestsPassedLastSubmission = false;
            startTimer(180);
        }

        submitCodeButton.addEventListener('click', () => {
            const userCode = codeEditor.value;
            const levelData = levels[currentLevel];
            allTestsPassedLastSubmission = true;
            let resultsLog = `Executing for Mission: ${levelData.title}\n\n`;

            stopTimer();

            try {
                let functionName;
                const fnNameMatchBackticks = levelData.problem.match(/`(\w+)`/);
                const fnNameMatchFunctionKeyword = levelData.problem.match(/function\s+(\w+)\s*\(/);

                if (fnNameMatchBackticks && fnNameMatchBackticks[1]) {
                    functionName = fnNameMatchBackticks[1];
                } else if (fnNameMatchFunctionKeyword && fnNameMatchFunctionKeyword[1]) {
                    functionName = fnNameMatchFunctionKeyword[1];
                } else {
                    throw new Error("Could not determine function name from problem description. Expected format: `yourFunction` or `function yourFunction(...)`.");
                }

                const scriptToRun = userCode + `\nif (typeof ${functionName} === 'function') return ${functionName}; else throw new Error("Function ${functionName} is not defined or not a function.");`;
                const userFunction = new Function(scriptToRun)();

                levelData.testCases.forEach((test, index) => {
                    resultsLog += `Test Case ${index + 1}:\n`;
                    resultsLog += `Input: ${JSON.stringify(test.input)}\n`;
                    let actualOutput;
                    try {
                        actualOutput = userFunction(test.input);
                        resultsLog += `Actual Output: ${JSON.stringify(actualOutput)}\n`;
                        resultsLog += `Expected Output: ${JSON.stringify(test.expected)}\n`;

                        if (JSON.stringify(actualOutput) === JSON.stringify(test.expected)) {
                            resultsLog += `Status: PASSED\n\n`;
                        } else {
                            resultsLog += `Status: FAILED\n\n`;
                            allTestsPassedLastSubmission = false;
                        }
                    } catch (e) {
                        resultsLog += `Runtime Error in Test Case ${index + 1} (${functionName}(${JSON.stringify(test.input)})): ${e.message}\nStatus: FAILED\n\n`;
                        allTestsPassedLastSubmission = false;
                    }
                });

            } catch (e) {
                resultsLog = `Error in your code or setup:\n${e.message}\n\nEnsure your function is correctly defined and named as specified.`;
                allTestsPassedLastSubmission = false;
            }

            outputArea.textContent = resultsLog;

            if (allTestsPassedLastSubmission) {
                codeFeedback.textContent = 'All test cases passed! Mission accomplished.';
                showResultScreen(true, `Level ${currentLevel + 1} Cleared!`, 100, 180 - timeLeft, "Excellent");
                updateUserProgress(currentLevel + 1);
                if (currentLevel < levels.length - 1) {
                    nextLevelButton.classList.remove('hidden');
                    nextLevelButton.disabled = false;
                    nextLevelButton.textContent = "Proceed to Next Mission";
                } else {
                    nextLevelButton.textContent = "All Missions Complete!";
                    nextLevelButton.classList.remove('hidden');
                    nextLevelButton.disabled = true;
                }
            } else {
                codeFeedback.textContent = 'Some test cases failed. Review your logic and the output logs.';
                showResultScreen(false, `Level ${currentLevel + 1} Attempt Failed`, 0, 180 - timeLeft, "Needs Review");
                nextLevelButton.classList.add('hidden');
            }
        });

        resetCodeButton.addEventListener('click', () => {
            if (confirm("Are you sure you want to reset your code for this level?")) {
                loadLevel(currentLevel);
            }
        });

        hintButton.addEventListener('click', () => {
            const levelData = levels[currentLevel];
            codeFeedback.textContent = levelData.hint ? `Hint: ${levelData.hint}` : 'No hints available for this mission.';
        });

        nextLevelButton.addEventListener('click', () => {
            if (allTestsPassedLastSubmission && currentLevel < levels.length - 1) {
                loadLevel(currentLevel + 1);
            } else if (currentLevel >= levels.length - 1 && allTestsPassedLastSubmission) {
                displayGameComplete();
            }
        });

        function startTimer(duration) {
            timeLeft = duration;
            clearInterval(levelTimerInterval);
            updateTimerDisplay();
            levelTimerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(levelTimerInterval);
                    timeDisplay.textContent = "Time's Up!";
                    codeFeedback.textContent = "Time's up! Mission compromised. Try again faster.";
                    submitCodeButton.disabled = true;
                    showResultScreen(false, `Level ${currentLevel + 1} Failed - Time Out`, 0, duration, "Time Out");
                    nextLevelButton.classList.add('hidden');
                }
            }, 1000);
            submitCodeButton.disabled = false;
        }

        function stopTimer() {
            clearInterval(levelTimerInterval);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        async function loadUserProgress() {
            let levelToLoad = 0;
            if (currentUser) {
                try {
                    const snapshot = await get(child(ref(database), `users/${currentUser.uid}/progress`));
                    if (snapshot.exists()) {
                        levelToLoad = snapshot.val().level || 0;
                    }
                } catch (error) {
                    console.error("Error loading user progress:", error);
                    codeFeedback.textContent = `Error loading progress: ${error.message}`;
                }
            } else {
                const savedProgress = localStorage.getItem('codeVeritasProgress');
                if (savedProgress) {
                    levelToLoad = JSON.parse(savedProgress).level || 0;
                }
            }
            currentLevel = (levelToLoad < levels.length && levelToLoad >= 0) ? levelToLoad : 0;
        }

        async function updateUserProgress(completedLevelNumber) {
            const newProgressLevelIndex = completedLevelNumber;
            if (currentUser) {
                try {
                    await set(ref(database, `users/${currentUser.uid}/progress`), {
                        level: newProgressLevelIndex,
                        lastPlayed: new Date().toISOString()
                    });
                } catch (error) {
                    console.error("Error saving user progress:", error);
                    codeFeedback.textContent = `Error saving progress: ${error.message}`;
                }
            } else {
                localStorage.setItem('codeVeritasProgress', JSON.stringify({ level: newProgressLevelIndex }));
            }
        }

        function loadLocalProgress() {
            const savedProgress = localStorage.getItem('codeVeritasProgress');
            let levelToLoad = 0;
            if (savedProgress) {
                levelToLoad = JSON.parse(savedProgress).level || 0;
            }
            currentLevel = (levelToLoad < levels.length && levelToLoad >= 0) ? levelToLoad : 0;
        }

        function displayGameComplete() {
            missionTitle.textContent = "All Missions Accomplished!";
            missionBrief.textContent = "You've successfully navigated all challenges. Your skills are undeniable, Agent.";
            problemText.textContent = "Further directives will be issued when available. Stand by.";
            codeEditor.value = "// System Standby //";
            codeEditor.disabled = true;
            submitCodeButton.disabled = true;
            hintButton.disabled = true;
            resetCodeButton.disabled = true;
            nextLevelButton.textContent = "All Missions Complete!";
            nextLevelButton.classList.remove('hidden');
            nextLevelButton.disabled = true;
            outputArea.textContent = "System Integrity: 100%\nAll Operations Successful.";
            stopTimer();
        }

        function showResultScreen(success, message, score, timeTaken, quality) {
            resultTitle.textContent = success ? "MISSION SUCCESSFUL" : "MISSION FAILED";
            resultTitle.style.color = success ? 'var(--success-color)' : 'var(--error-color)';
            resultMessage.textContent = message;
            scoreValue.textContent = score;
            timeValue.textContent = `${timeTaken}s`;
            qualityValue.textContent = quality;
            resultModal.classList.remove('hidden');
        }

        closeResultModalButton.addEventListener('click', () => {
            resultModal.classList.add('hidden');
            if (!allTestsPassedLastSubmission) {
                if (timeLeft <= 0) {
                    loadLevel(currentLevel);
                } else {
                    submitCodeButton.disabled = false;
                }
            }
        });

        // Matrix Rain Effect
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const letters = '0123456789ABCDEF';
        const fontSize = 14;
        let columns = Math.floor(canvas.width / fontSize);
        const drops = [];
        for (let x = 0; x < columns; x++) drops[x] = 1 + Math.floor(Math.random() * (canvas.height / fontSize));

        function drawMatrix() {
            ctx.fillStyle = 'rgba(10, 10, 10, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(0, 255, 65, 0.7)';
            ctx.font = fontSize + 'px monospace';
            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        let matrixInterval = setInterval(drawMatrix, 50);

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            columns = Math.floor(canvas.width / fontSize);
            drops.length = 0;
            for (let x = 0; x < columns; x++) drops[x] = 1 + Math.floor(Math.random() * (canvas.height / fontSize));
        });
    </script>
</body>
</html>