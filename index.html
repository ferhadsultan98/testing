<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Manage - Farhad</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* CSS Variables for Color Palette */
        :root {
            --primary-color: #4CAF50; /* Green */
            --accent-color: #2196F3; /* Blue */
            --warn-color: #FF9800; /* Orange */
            --danger-color: #F44336; /* Red */
            --text-color: #333;
            --secondary-text-color: #666;
            --background-color: #f4f7f6; /* Light Grey */
            --surface-color: #ffffff; /* White */
            --border-color: #e0e0e0; /* Light Grey Border */
            --shadow-color: rgba(0, 0, 0, 0.1);
            --gradient-start: #e0f2f7; /* Very Light Cyan */
            --gradient-end: #e8f5e9; /* Very Light Green */
        }

        /* General Body Styles */
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow: hidden; /* Prevent body scroll, content area will scroll */
        }

        /* Responsive Container */
        .container {
            max-width: 500px; /* Typical mobile width */
            margin: 0 auto;
            padding: 0;
            height: 100vh; /* Full viewport height */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Hide main app initially */
        #mainApp {
            display: none;
            flex-direction: column;
            height: 100%; /* Take full height of container */
        }

        /* Fixed Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 500px; /* Match container max-width */
            margin: 0 auto; /* Center header */
            height: 60px;
            background-color: var(--surface-color);
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 1000;
            box-sizing: border-box; /* Include padding in width */
        }

        .profileCircle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--border-color); /* Placeholder color */
            overflow: hidden;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
             border: 2px solid var(--primary-color); /* Add a border */
        }

        .profileCircle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .headerIcons {
            display: flex;
            align-items: center;
        }

        .settingsIcon, .notificationIcon {
            font-size: 24px;
            color: var(--secondary-text-color);
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s ease;
        }

        .settingsIcon:hover, .notificationIcon:hover {
             color: var(--primary-color);
        }

        /* Notification icon animation */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); } /* Using --danger-color */
            70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
        .notificationIcon.hasNotifications {
            color: var(--danger-color); /* Change color when has notifications */
            animation: pulse 1.5s infinite;
        }


        /* Fixed Bottom Navbar */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 500px; /* Match container max-width */
            margin: 0 auto; /* Center footer */
            height: 60px;
            background-color: var(--surface-color);
            box-shadow: 0 -2px 4px var(--shadow-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            box-sizing: border-box; /* Include padding in width */
        }

        .navItem {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--secondary-text-color);
            font-size: 12px;
            flex: 1; /* Distribute space evenly */
            transition: color 0.3s ease;
        }

        .navItem.active {
            color: var(--primary-color); /* Active color */
        }
         .navItem:hover {
            color: var(--primary-color); /* Hover color */
        }

        .navItem i {
            font-size: 20px; /* Icon size */
            margin-bottom: 4px;
        }

        /* Main Content Area */
        .mainContent {
            flex-grow: 1; /* Take available space */
            padding: 75px 15px 75px 15px; /* Space for fixed header and footer + side padding */
            overflow-y: auto; /* Make content area scrollable */
            -webkit-overflow-scrolling: touch; /* Enable smooth scrolling on iOS */
            box-sizing: border-box; /* Include padding in height calculation if flex is not used */
            width: 100%;
            max-width: 500px; /* Match container */
            margin: 0 auto; /* Center content */
        }

        /* Page Sections */
        .pageSection {
            display: none;
            width: 100%; /* Take full width of mainContent */
        }

        .pageSection.active {
            display: block;
             /* Add animation for smooth transition */
             animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Landing/Auth Page Styles */
        #authPage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(to bottom right, var(--gradient-start), var(--gradient-end)); /* Gradient background */
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .appName {
             font-size: 32px;
             font-weight: bold;
             color: var(--primary-color);
             margin-bottom: 30px;
             text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .authButtons {
             margin-top: 20px;
        }

        .authButtons button {
             padding: 14px 28px;
             margin: 0 10px;
             border: none;
             border-radius: 25px; /* Pill shape */
             cursor: pointer;
             font-size: 18px;
             font-weight: bold;
             transition: background-color 0.3s ease, transform 0.1s ease;
             box-shadow: 0 4px 8px var(--shadow-color);
        }
        .authButtons button#showLogin {
             background-color: var(--primary-color);
             color: white;
        }
        .authButtons button#showRegister {
             background-color: var(--accent-color);
             color: white;
        }
         .authButtons button:active {
            transform: scale(0.95);
        }


        #loginForm, #registerForm {
            display: none; /* Hidden initially */
            padding: 30px 20px;
            background-color: var(--surface-color);
            border-radius: 15px;
            box-shadow: 0 8px 16px var(--shadow-color);
            width: 100%; /* Responsive width */
            max-width: 400px; /* Max form width */
            margin-top: 30px;
            box-sizing: border-box;
        }

         #loginForm.active, #registerForm.active {
             display: block;
         }

        .authForm h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 24px;
        }

        .formGroup {
            margin-bottom: 20px;
            text-align: left;
        }

        .formGroup label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--secondary-text-color);
            font-size: 14px;
        }

        .formGroup input:not([type="file"]), .formGroup select, .formGroup textarea {
            width: 100%; /* Full width minus padding */
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Soft corners */
            font-size: 16px;
            box-sizing: border-box; /* Include padding in width */
            transition: border-color 0.3s ease;
        }
        .formGroup input:focus, .formGroup select:focus, .formGroup textarea:focus {
             outline: none;
             border-color: var(--primary-color);
             box-shadow: 0 0 5px rgba(76, 175, 80, 0.3); /* Subtle glow */
        }

         .passwordGroup {
              position: relative;
         }
         .passwordGroup input {
             padding-right: 40px; /* Space for icon */
         }
         .passwordToggle {
              position: absolute;
              right: 12px;
              top: 65%; /* Center vertically relative to input */
              transform: translateY(-50%);
              cursor: pointer;
              color: var(--secondary-text-color);
              font-size: 18px;
         }
         .passwordToggle:hover {
              color: var(--text-color);
         }


        .authForm button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
         .authForm button:hover {
            background-color: #388e3c; /* Darker green */
        }
         .authForm button:active {
             transform: scale(0.98);
         }


        .switchAuth {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 14px;
            transition: color 0.3s ease;
        }
         .switchAuth:hover {
             color: #1565c0; /* Darker blue */
             text-decoration: underline;
         }

        /* Dashboard Page Styles */
        #dashboardPage h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 24px;
        }

        .summaryCard {
             background-color: var(--surface-color);
             padding: 20px;
             margin-bottom: 20px;
             border-radius: 12px;
             box-shadow: 0 4px 8px var(--shadow-color);
        }
         .summaryCard h3 {
             margin-top: 0;
             color: var(--primary-color); /* Accent color */
             font-size: 18px;
             margin-bottom: 10px;
         }
         .summaryCard p {
             margin: 5px 0;
             font-size: 15px;
             color: var(--secondary-text-color);
         }
         .summaryCard p strong {
              color: var(--text-color);
         }

        #expenseList, #loanList {
             margin-top: 20px;
        }

         #expenseList p, #loanList p {
             text-align: center;
             color: var(--secondary-text-color);
         }


        .expenseItem, .loanItem {
            background-color: var(--surface-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Indicate clickable */
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
         .expenseItem:active, .loanItem:active {
             transform: scale(0.98);
         }

        .expenseItem .details, .loanItem .details {
            flex-grow: 1;
            margin-right: 10px;
        }

        .expenseItem .details h3, .loanItem .details h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: var(--text-color);
        }

        .expenseItem .details p, .loanItem .details p {
            margin: 0;
            font-size: 13px;
            color: var(--secondary-text-color);
        }

        .expenseItem .amount {
            font-size: 17px;
            font-weight: bold;
            color: var(--danger-color); /* Red for expense */
        }
         .loanItem .amount {
             font-size: 17px;
             font-weight: bold;
             color: var(--primary-color); /* Green for loan payment indication */
         }


        .exportButtons {
            text-align: center;
            margin-top: 25px;
        }

        .exportButtons button {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
         .exportButtons button:active {
             transform: scale(0.95);
         }

        .exportButtons .pdfButton {
            background-color: var(--danger-color); /* Red */
            color: white;
        }
         .exportButtons .pdfButton:hover {
             background-color: #d32f2f;
         }

        .exportButtons .excelButton {
            background-color: var(--primary-color); /* Green */
            color: white;
        }
        .exportButtons .excelButton:hover {
             background-color: #388e3c;
        }

        /* Add Expense/Loan Form Styles (Similar to Auth form) */
        #addExpensePage h2, #loanPage h2 {
             text-align: center;
             margin-bottom: 25px;
             color: var(--text-color);
             font-size: 24px;
        }
         #loanPage button#addLoanButton {
             display: block;
             width: auto; /* Adjust width */
             margin: 20px auto; /* Center button */
             padding: 10px 20px;
             background-color: var(--accent-color);
             color: white;
             border-radius: 8px;
             font-size: 16px;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
          #loanPage button#addLoanButton:hover {
              background-color: #1565c0;
          }


        /* Expense Details Page */
        #expenseDetailsPage h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 24px;
        }
         #expenseDetailsContent {
             background-color: var(--surface-color);
             padding: 20px;
             border-radius: 12px;
             box-shadow: 0 4px 8px var(--shadow-color);
             margin-bottom: 20px;
         }
         #expenseDetailsContent p {
             margin: 8px 0;
             font-size: 16px;
             color: var(--text-color);
         }
          #expenseDetailsContent p strong {
              color: var(--secondary-text-color);
          }

         #expenseDetailsPage button {
              padding: 10px 20px;
              margin-right: 10px;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              transition: background-color 0.3s ease;
               box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
          #expenseDetailsPage button#editExpenseButton {
              background-color: var(--accent-color); /* Blue */
              color: white;
          }
           #expenseDetailsPage button#editExpenseButton:hover {
               background-color: #1565c0;
           }
           #expenseDetailsPage button#deleteExpenseButton {
               background-color: var(--danger-color); /* Red */
               color: white;
           }
            #expenseDetailsPage button#deleteExpenseButton:hover {
               background-color: #d32f2f;
           }


        /* Settings Page Styles */
        #settingsPage h2 {
             text-align: center;
             margin-bottom: 25px;
             color: var(--text-color);
             font-size: 24px;
        }
        .settingsGroup {
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        .settingsGroup h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color); /* Accent color */
            font-size: 18px;
        }

         .settingsGroup button {
             width: 100%;
             padding: 12px;
             background-color: var(--accent-color); /* Blue */
             color: white;
             border: none;
             border-radius: 8px;
             cursor: pointer;
             font-size: 16px;
             font-weight: bold;
             margin-top: 10px;
             transition: background-color 0.3s ease, transform 0.1s ease;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
         .settingsGroup button:hover {
              background-color: #1565c0;
         }
         .settingsGroup button:active {
              transform: scale(0.98);
         }

         #settingsPage p {
             font-size: 15px;
             color: var(--secondary-text-color);
             margin: 8px 0;
         }
          #settingsPage p strong {
               color: var(--text-color);
          }

        #logoutButton {
            display: block;
            width: 100%;
            padding: 14px;
            background-color: var(--danger-color); /* Red */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin-top: 30px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
        }
         #logoutButton:hover {
             background-color: #d32f2f;
         }
          #logoutButton:active {
              transform: scale(0.98);
          }


        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.5); /* Black w/ opacity */
            justify-content: center; /* Center content */
            align-items: center; /* Center content */
             opacity: 0; /* Start invisible for animation */
             pointer-events: none; /* Prevent clicks when hidden */
             transition: opacity 0.3s ease;
        }

        .modal.visible {
             display: flex; /* Show using flex */
             opacity: 1;
             pointer-events: auto; /* Enable clicks */
        }


        .modalContent {
            background-color: var(--surface-color);
            margin: auto; /* Centers the modal content */
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%; /* Responsive width */
            max-width: 400px; /* Max width */
            position: relative;
            transform: translateY(20px); /* Start slightly lower for animation */
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0; /* Start invisible for animation */
        }

        .modal.visible .modalContent {
             transform: translateY(0); /* Slide up */
             opacity: 1;
        }


        .closeButton {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--secondary-text-color);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .closeButton:hover,
        .closeButton:focus {
            color: var(--text-color);
            text-decoration: none;
        }

         .modalContent h2 {
             text-align: center;
             margin-top: 0;
             margin-bottom: 20px;
             color: var(--text-color);
             font-size: 22px;
         }
         .modalContent .formGroup label {
             font-size: 14px;
         }
          .modalContent .formGroup input:not([type="file"]), .modalContent .formGroup select, .modalContent .formGroup textarea {
              padding: 10px; /* Slightly smaller padding in modal */
          }
         .modalContent button {
              width: 100%;
              padding: 12px;
              background-color: var(--primary-color);
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              font-weight: bold;
              margin-top: 15px;
              transition: background-color 0.3s ease;
               box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
         }
         .modalContent button:hover {
             background-color: #388e3c;
         }

         /* Notification list specific styles */
         #notificationList .notificationItem {
              background-color: #e8f5e9; /* Light green background */
              border-left: 5px solid var(--primary-color); /* Green border */
              padding: 15px;
              margin-bottom: 10px;
              border-radius: 8px;
              box-shadow: 0 1px 3px rgba(0,0,0,0.08);
         }
         #notificationList .notificationItem p {
             margin: 0 0 5px 0;
             font-size: 15px;
             color: var(--text-color);
         }
          #notificationList .notificationItem p strong {
               color: var(--primary-color);
          }
         #notificationList .notificationItem .notificationTime {
             display: block;
             font-size: 12px;
             color: var(--secondary-text-color);
             text-align: right;
         }
          #notificationList .notificationItem:last-child {
              margin-bottom: 0;
          }


        /* Utility Classes */
        .hidden { display: none; }


    </style>
</head>
<body>

    <div class="container">

        <div id="authPage" class="pageSection">
            <div class="appName">Expense Manage</div>
            <div class="authButtons">
                <button id="showLogin">Giriş</button>
                <button id="showRegister">Qeydiyyat</button>
            </div>

            <div id="loginForm" class="authForm">
                <h2>Giriş</h2>
                <div class="formGroup">
                    <label for="loginEmail">Email</label> <input type="email" id="loginEmail" placeholder="Email ünvanınızı daxil edin">
                </div>
                <div class="formGroup passwordGroup">
                    <label for="loginPassword">Şifrə</label>
                    <input type="password" id="loginPassword" placeholder="Şifrənizi daxil edin">
                    <span class="passwordToggle" data-target="loginPassword"><i class="far fa-eye"></i></span>
                </div>
                <button id="loginButton">Giriş</button>
                <span class="switchAuth" data-target="register">Hesabınız yoxdur? Qeydiyyatdan keçin</span>
            </div>

            <div id="registerForm" class="authForm">
                 <h2>Qeydiyyat</h2>
                 <div class="formGroup">
                     <label for="registerFullName">Ad Soyad</label>
                     <input type="text" id="registerFullName" placeholder="Adınızı və Soyadınızı daxil edin">
                 </div>
                 <div class="formGroup">
                     <label for="registerUsername">İstifadəçi Adı</label>
                     <input type="text" id="registerUsername" placeholder="İstifadəçi adı yaradın">
                 </div>
                 <div class="formGroup">
                     <label for="registerBirthDate">Doğum Tarixi</label>
                     <input type="date" id="registerBirthDate">
                 </div>
                 <div class="formGroup">
                     <label for="registerBirthPlace">Doğum Yeri</label>
                     <input type="text" id="registerBirthPlace" placeholder="Doğum yerinizi daxil edin">
                 </div>
                 <div class="formGroup">
                     <label for="registerGender">Cinsiyyət</label>
                     <select id="registerGender">
                         <option value="">Seçin</option>
                         <option value="male">Kişi</option>
                         <option value="female">Qadın</option>
                         <option value="other">Digər</option>
                     </select>
                 </div>
                 <div class="formGroup">
                     <label for="registerProfilePic">Profil Şəkli</label>
                     <input type="file" id="registerProfilePic" accept="image/*">
                 </div>
                 <div class="formGroup">
                      <label for="registerEmail">Email</label>
                      <input type="email" id="registerEmail" placeholder="Email ünvanınızı daxil edin">
                 </div>
                 <div class="formGroup passwordGroup">
                     <label for="registerPassword">Şifrə</label>
                     <input type="password" id="registerPassword" placeholder="Şifrə yaradın">
                      <span class="passwordToggle" data-target="registerPassword"><i class="far fa-eye"></i></span>
                 </div>
                 <div class="formGroup passwordGroup">
                     <label for="registerRepassword">Şifrə Təkrar</label>
                     <input type="password" id="registerRepassword" placeholder="Şifrəni təkrar daxil edin">
                      <span class="passwordToggle" data-target="registerRepassword"><i class="far fa-eye"></i></span>
                 </div>
                 <button id="registerButton">Qeydiyyatdan Keç</button>
                 <span class="switchAuth" data-target="login">Artıq hesabınız var? Giriş edin</span>
            </div>

        </div>

        <div id="mainApp">

            <header>
                <div class="profileCircle" id="headerProfilePic">
                     <img src="" alt="Profil Şəkli"> </div>
                 <div class="headerIcons">
                    <i class="fas fa-bell notificationIcon" id="showNotifications"></i>
                    <i class="fas fa-cog settingsIcon" id="showSettingsPage"></i>
                 </div>
            </header>

            <div class="mainContent">

                <div id="dashboardPage" class="pageSection">
                     <h2>Əsas Panel</h2>
                     <div id="balanceSummary" class="summaryCard">
                         </div>
                     <div id="loanSummary" class="summaryCard">
                         </div>
                     <h3>Son Xərclər</h3>
                     <div id="expenseList">
                          </div>
                     <div class="exportButtons">
                         <button class="pdfButton" id="exportPdf"><i class="fas fa-file-pdf"></i> PDF İndir</button>
                         <button class="excelButton" id="exportExcel"><i class="fas fa-file-excel"></i> Excel İndir</button>
                     </div>
                </div>

                 <div id="addExpensePage" class="pageSection">
                     <h2>Xərc Əlavə Et</h2>
                      <div class="formGroup">
                         <label for="expenseAmount">Məbləğ (AZN)</label>
                         <input type="number" id="expenseAmount" step="0.01" placeholder="0.00">
                     </div>
                      <div class="formGroup">
                         <label for="expenseDate">Tarix</label>
                         <input type="date" id="expenseDate">
                     </div>
                      <div class="formGroup">
                         <label for="expenseCategory">Kateqoriya</label>
                         <select id="expenseCategory">
                             <option value="">Kateqoriya Seçin</option>
                             <option value="food">Qida</option>
                             <option value="transport">Nəqliyyat</option>
                             <option value="shopping">Alış-veriş</option>
                             <option value="utilities">Kommunal</option>
                              <option value="health">Sağlamlıq</option>
                             <option value="entertainment">Əyləncə</option>
                             <option value="other">Digər</option>
                         </select>
                     </div>
                      <div class="formGroup">
                         <label for="expenseNote">Qeyd (istəyə bağlı)</label>
                         <textarea id="expenseNote" placeholder="Xərc barədə qeyd"></textarea>
                     </div>
                     <button id="saveExpenseButton"><i class="fas fa-save"></i> Xərci Yadda Saxla</button>
                 </div>

                 <div id="expenseDetailsPage" class="pageSection">
                     <h2>Xərc Detalları</h2>
                     <div id="expenseDetailsContent">
                         </div>
                      <button id="editExpenseButton"><i class="fas fa-edit"></i> Redaktə Et</button>
                      <button id="deleteExpenseButton"><i class="fas fa-trash-alt"></i> Sil</button>
                 </div>

                 <div id="loanPage" class="pageSection">
                     <h2>Kreditlərim</h2>
                      <button id="addLoanButton"><i class="fas fa-plus"></i> Yeni Kredit Əlavə Et</button>
                      <div id="loanList">
                           </div>
                 </div>

                  <div id="addLoanModal" class="modal">
                      <div class="modalContent">
                           <span class="closeButton">&times;</span>
                            <h2>Yeni Kredit Əlavə Et</h2>
                            <div class="formGroup">
                                <label for="loanName">Kreditin Adı</label>
                                <input type="text" id="loanName" placeholder="Məsələn: Ev Krediti">
                            </div>
                             <div class="formGroup">
                                <label for="loanTotalAmount">Ümumi Məbləğ (AZN)</label>
                                <input type="number" id="loanTotalAmount" step="0.01" placeholder="0.00">
                            </div>
                             <div class="formGroup">
                                <label for="loanMonthlyPayment">Aylıq Ödəniş (AZN)</label>
                                <input type="number" id="loanMonthlyPayment" step="0.01" placeholder="0.00">
                            </div>
                            <div class="formGroup">
                                <label for="loanStartDate">Başlanğıc Tarixi</label>
                                <input type="date" id="loanStartDate">
                            </div>
                             <div class="formGroup">
                                <label for="loanNextPaymentDate">Növbəti Ödəniş Tarixi</label>
                                <input type="date" id="loanNextPaymentDate">
                            </div>
                             <div class="formGroup">
                                <label for="loanNote">Qeyd (istəyə bağlı)</label>
                                <textarea id="loanNote" placeholder="Kredit barədə qeyd"></textarea>
                            </div>
                             <button id="saveLoanButton"><i class="fas fa-save"></i> Krediti Yadda Saxla</button>
                      </div>
                 </div>


                 <div id="settingsPage" class="pageSection">
                     <h2>Tənzimləmələr</h2>

                     <div class="settingsGroup">
                         <h3>Balans</h3>
                          <div class="formGroup">
                             <label for="currentBalance">Cari Balans (AZN)</label>
                             <input type="number" id="currentBalance" step="0.01" readonly> </div>
                          <div class="formGroup">
                             <label for="addBalanceAmount">Balans Artır (AZN)</label>
                             <input type="number" id="addBalanceAmount" step="0.01" placeholder="0.00">
                         </div>
                          <button id="addBalanceButton"><i class="fas fa-plus"></i> Balansı Artır</button>
                     </div>

                     <div class="settingsGroup">
                          <h3>Aylıq Büdcə Limiti</h3>
                          <div class="formGroup">
                             <label for="monthlyBudgetLimit">Limit (AZN)</label>
                              <input type="number" id="monthlyBudgetLimit" step="0.01" placeholder="0.00">
                          </div>
                          <button id="saveBudgetLimit"><i class="fas fa-save"></i> Limiti Yadda Saxla</button>
                          <p>Cari Ayın Büdcə Qalıqı: <strong id="currentBudgetRemaining">-</strong> AZN</p>
                     </div>


                      <div class="settingsGroup">
                          <h3>Şifrəni Dəyiş</h3>
                           <div class="formGroup passwordGroup">
                             <label for="currentPassword">Cari Şifrə</label>
                             <input type="password" id="currentPassword" placeholder="Cari şifrənizi daxil edin">
                              <span class="passwordToggle" data-target="currentPassword"><i class="far fa-eye"></i></span>
                         </div>
                          <div class="formGroup passwordGroup">
                             <label for="newPassword">Yeni Şifrə</label>
                             <input type="password" id="newPassword" placeholder="Yeni şifrə yaradın">
                              <span class="passwordToggle" data-target="newPassword"><i class="far fa-eye"></i></span>
                         </div>
                          <div class="formGroup passwordGroup">
                             <label for="confirmNewPassword">Yeni Şifrə Təkrar</label>
                             <input type="password" id="confirmNewPassword" placeholder="Yeni şifrəni təkrar daxil edin">
                              <span class="passwordToggle" data-target="confirmNewPassword"><i class="far fa-eye"></i></span>
                         </div>
                          <button id="changePasswordButton"><i class="fas fa-lock"></i> Şifrəni Dəyiş</button>
                      </div>

                      <div class="settingsGroup">
                          <h3>Ümumi Məlumat</h3>
                          <p>Proqram Adı: <strong>Expense Manage</strong></p>
                          <p>Versiya: <strong>1.0.0</strong></p> <p>İl: <strong id="appYear"></strong></p> <p>Hazırlayan: <strong>Farhad</strong></p>
                      </div>

                       <button id="logoutButton"><i class="fas fa-sign-out-alt"></i> Çıxış</button>

                 </div>

                 <div id="reportsPage" class="pageSection">
                       <h2>Hesabatlar</h2>
                       <p>Hesabat funksionallığı hələ tətbiq olunmayıb.</p>
                        </div>


            </div>

            <footer>
                <a href="#" class="navItem" data-section="dashboardPage">
                    <i class="fas fa-home"></i>
                    <span>Əsas</span>
                </a>
                <a href="#" class="navItem" data-section="addExpensePage">
                     <i class="fas fa-plus-circle"></i>
                    <span>Xərc Əlavə</span>
                </a>
                 <a href="#" class="navItem" data-section="loanPage">
                     <i class="fas fa-wallet"></i>
                    <span>Kreditlər</span>
                 </a>
                  <a href="#" class="navItem" data-section="reportsPage">
                       <i class="fas fa-chart-bar"></i>
                       <span>Hesabatlar</span>
                   </a>
            </footer>

            <div id="profileEditModal" class="modal">
                 <div class="modalContent">
                      <span class="closeButton">&times;</span>
                       <h2>Profilimi Redaktə Et</h2>
                       <div class="formGroup">
                             <label for="editFullName">Ad Soyad</label>
                             <input type="text" id="editFullName" placeholder="Adınızı və Soyadınızı daxil edin">
                         </div>
                         <div class="formGroup">
                             <label for="editUsername">İstifadəçi Adı</label>
                             <input type="text" id="editUsername" placeholder="İstifadəçi adınız">
                         </div>
                         <div class="formGroup">
                             <label for="editBirthDate">Doğum Tarixi</label>
                             <input type="date" id="editBirthDate">
                         </div>
                         <div class="formGroup">
                             <label for="editBirthPlace">Doğum Yeri</label>
                             <input type="text" id="editBirthPlace" placeholder="Doğum yeriniz">
                         </div>
                         <div class="formGroup">
                             <label for="editGender">Cinsiyyət</label>
                             <select id="editGender">
                                 <option value="">Seçin</option>
                                 <option value="male">Kişi</option>
                                 <option value="female">Qadın</option>
                                 <option value="other">Digər</option>
                             </select>
                         </div>
                         <div class="formGroup">
                             <label for="editProfilePic">Profil Şəkli</label>
                             <input type="file" id="editProfilePic" accept="image/*">
                              </div>
                         <div class="formGroup">
                              <label for="editEmail">Email</label>
                              <input type="email" id="editEmail" readonly placeholder="Email ünvanınız (dəyişdirilə bilməz)"> </div>
                         <button id="saveProfileButton"><i class="fas fa-save"></i> Yadda Saxla</button>
                 </div>
            </div>

            <div id="notificationModal" class="modal">
                 <div class="modalContent">
                      <span class="closeButton">&times;</span>
                       <h2>Bildirişlər</h2>
                        <div id="notificationList">
                             </div>
                 </div>
             </div>


        </div>

    </div> <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script> <script>
        // Your Firebase Config (provided by user)
        const firebaseConfig = {
          apiKey: "AIzaSyCbEC5U7QcqhaSU-EM2S-5G4lA7o-pnFYI",
          authDomain: "projects-34769.firebaseapp.com",
          databaseURL: "https://projects-34769-default-rtdb.firebaseio.com", // Using Realtime DB based on URL
          projectId: "projects-34769",
          storageBucket: "projects-34769.firebasestorage.app",
          messagingSenderId: "740273672797",
          appId: "1:740273672797:web:9c9df9bf330315c80533b4"
        };

        // Cloudinary Config (provided by user)
        const cloudinaryPreset = "farhadsultan";
        const cloudinaryCloudName = "dbiltdpxh";
        // Direct upload URL for Cloudinary
        const cloudinaryUploadUrl = `https://api.cloudinary.com/v1_1/${cloudinaryCloudName}/image/upload`;


        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database(); // Using Realtime Database
        const storage = firebase.storage(); // Firebase Storage is not strictly needed if using Cloudinary direct upload

        // --- DOM Elements ---
        const authPage = document.getElementById('authPage');
        const mainApp = document.getElementById('mainApp');
        const showLoginButton = document.getElementById('showLogin');
        const showRegisterButton = document.getElementById('showRegister');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const switchAuthSpans = document.querySelectorAll('.switchAuth');
        const passwordToggles = document.querySelectorAll('.passwordToggle');

        const headerProfilePic = document.getElementById('headerProfilePic');
        const showSettingsPageButton = document.getElementById('showSettingsPage');
        const showNotificationsButton = document.getElementById('showNotifications');
        const notificationIcon = document.querySelector('.notificationIcon');


        const navItems = document.querySelectorAll('.navItem');
        const pageSections = document.querySelectorAll('.pageSection');

        // Pages
        const dashboardPage = document.getElementById('dashboardPage');
        const addExpensePage = document.getElementById('addExpensePage');
        const expenseDetailsPage = document.getElementById('expenseDetailsPage');
        const loanPage = document.getElementById('loanPage');
        const settingsPage = document.getElementById('settingsPage');
        const reportsPage = document.getElementById('reportsPage'); // Added reports page


        // Modals
        const profileEditModal = document.getElementById('profileEditModal');
        const notificationModal = document.getElementById('notificationModal');
        const addLoanModal = document.getElementById('addLoanModal');
        const closeButtons = document.querySelectorAll('.modal .closeButton');

        // Forms & Buttons (partial list)
        const registerFormElements = {
            fullName: document.getElementById('registerFullName'),
            username: document.getElementById('registerUsername'),
            birthDate: document.getElementById('registerBirthDate'),
            birthPlace: document.getElementById('registerBirthPlace'),
            gender: document.getElementById('registerGender'),
            profilePic: document.getElementById('registerProfilePic'),
            email: document.getElementById('registerEmail'),
            password: document.getElementById('registerPassword'),
            repassword: document.getElementById('registerRepassword'),
        };

        const loginFormElements = {
             email: document.getElementById('loginEmail'), // Changed from username to email for Firebase Auth
             password: document.getElementById('loginPassword')
        };

        const addExpenseFormElements = {
             amount: document.getElementById('expenseAmount'),
             date: document.getElementById('expenseDate'),
             category: document.getElementById('expenseCategory'),
             note: document.getElementById('expenseNote')
        };
         const saveExpenseButton = document.getElementById('saveExpenseButton');

        const settingsElements = {
             currentBalance: document.getElementById('currentBalance'),
             addBalanceAmount: document.getElementById('addBalanceAmount'),
             addBalanceButton: document.getElementById('addBalanceButton'),
             monthlyBudgetLimit: document.getElementById('monthlyBudgetLimit'),
             saveBudgetLimit: document.getElementById('saveBudgetLimit'),
             currentBudgetRemaining: document.getElementById('currentBudgetRemaining'),
             currentPassword: document.getElementById('currentPassword'),
             newPassword: document.getElementById('newPassword'),
             confirmNewPassword: document.getElementById('confirmNewPassword'),
             changePasswordButton: document.getElementById('changePasswordButton'),
             logoutButton: document.getElementById('logoutButton'),
             appYear: document.getElementById('appYear') // Element for dynamic year
        };

         const profileEditFormElements = {
            fullName: document.getElementById('editFullName'),
            username: document.getElementById('editUsername'),
            birthDate: document.getElementById('editBirthDate'),
            birthPlace: document.getElementById('editBirthPlace'),
            gender: document.getElementById('editGender'),
            profilePic: document.getElementById('editProfilePic'),
            email: document.getElementById('editEmail'), // Readonly
        };
        const saveProfileButton = document.getElementById('saveProfileButton');

        const addLoanModalElements = {
             modal: addLoanModal,
             name: document.getElementById('loanName'),
             totalAmount: document.getElementById('loanTotalAmount'),
             monthlyPayment: document.getElementById('loanMonthlyPayment'),
             startDate: document.getElementById('loanStartDate'),
             nextPaymentDate: document.getElementById('loanNextPaymentDate'),
             note: document.getElementById('loanNote'),
             saveButton: document.getElementById('saveLoanButton')
        };
         const addLoanButton = document.getElementById('addLoanButton'); // Button on Loan Page


         const expenseDetailsElements = {
             contentDiv: document.getElementById('expenseDetailsContent'),
             editButton: document.getElementById('editExpenseButton'),
             deleteButton: document.getElementById('deleteExpenseButton')
         };

         const expenseListDiv = document.getElementById('expenseList');
         const loanListDiv = document.getElementById('loanList');
         const notificationListDiv = document.getElementById('notificationList');
         const balanceSummaryDiv = document.getElementById('balanceSummary');
         const loanSummaryDiv = document.getElementById('loanSummary');


        // --- State Variables ---
        let currentUser = null; // Firebase User object
        let userProfile = null; // User data from Firebase (including balance, budget, etc.)
        let expenses = []; // Array of expenses for the current user
        let loans = []; // Array of loans for the current user
        let notifications = []; // Array of notifications


        // --- Firebase & Cloudinary Logic ---

        // Function to upload image to Cloudinary
        async function uploadImageToCloudinary(file) {
             if (!file) return null;

             const formData = new FormData();
             formData.append('file', file);
             formData.append('upload_preset', cloudinaryPreset);

             try {
                 const response = await fetch(cloudinaryUploadUrl, {
                     method: 'POST',
                     body: formData,
                 });
                 const data = await response.json();
                 console.log('Cloudinary upload data:', data);
                 if (data.secure_url) {
                     return data.secure_url; // Return the secure URL
                 } else {
                     console.error('Cloudinary upload failed:', data);
                     alert('Şəkil yüklənərkən xəta baş verdi: Cloudinary xətası.');
                     return null;
                 }
             } catch (error) {
                 console.error('Error uploading to Cloudinary:', error);
                 alert('Şəkil yüklənərkən xəta baş verdi. Şəbəkə xətası ola bilər.');
                 return null;
             }
         }


         // Firebase Authentication State Listener
         auth.onAuthStateChanged(async (user) => {
             if (user) {
                 // User is signed in.
                 currentUser = user;
                 console.log('User signed in:', user.uid);
                 await loadUserData(user.uid); // Load user data from DB
                 showMainApp();
             } else {
                 // User is signed out.
                 console.log('User signed out');
                 currentUser = null;
                 userProfile = null;
                 expenses = [];
                 loans = [];
                 notifications = [];
                 showAuthPage();
             }
         });

        // --- Data Loading from Firebase ---
        async function loadUserData(uid) {
            try {
                // Load profile, settings, budget, balance from /users/{uid}
                const userRef = database.ref('users/' + uid);
                userRef.on('value', (snapshot) => { // Use 'on' for real-time updates
                    userProfile = snapshot.val() || {};
                    console.log('User profile loaded:', userProfile);
                    updateProfileDisplay();
                    updateSettingsDisplay();
                    updateDashboardSummary();
                    // Notifications depend on expenses and loans, called after loading them
                     checkAndGenerateNotifications();
                     displayNotifications();
                }, (error) => {
                    console.error('Error loading user profile:', error);
                    alert('Profil məlumatları yüklənərkən xəta baş verdi.');
                });


                // Load expenses from /expenses/{uid}
                 const expensesRef = database.ref('expenses/' + uid);
                 expensesRef.on('value', (snapshot) => { // Use 'on' for real-time updates
                     const expensesData = snapshot.val();
                     expenses = [];
                     if (expensesData) {
                         for (const key in expensesData) {
                              // Ensure amount is number, date is string, handle missing fields
                             expenses.push({
                                 id: key,
                                 amount: parseFloat(expensesData[key].amount) || 0,
                                 date: expensesData[key].date || '',
                                 category: expensesData[key].category || 'other',
                                 note: expensesData[key].note || '',
                                 createdAt: expensesData[key].createdAt || new Date().toISOString() // Fallback
                             });
                         }
                     }
                     console.log('Expenses loaded:', expenses);
                     displayExpenses();
                     updateDashboardSummary(); // Update budget calculation
                     checkAndGenerateNotifications(); // Check budget notifications
                     displayNotifications();
                 }, (error) => {
                    console.error('Error loading expenses:', error);
                    alert('Xərc məlumatları yüklənərkən xəta baş verdi.');
                 });


                // Load loans from /loans/{uid}
                 const loansRef = database.ref('loans/' + uid);
                 loansRef.on('value', (snapshot) => { // Use 'on' for real-time updates
                     const loansData = snapshot.val();
                     loans = [];
                     if (loansData) {
                         for (const key in loansData) {
                              // Ensure number types and handle missing fields
                              loans.push({
                                  id: key,
                                  name: loansData[key].name || 'Naməlum Kredit',
                                  totalAmount: parseFloat(loansData[key].totalAmount) || 0,
                                  monthlyPayment: parseFloat(loansData[key].monthlyPayment) || 0,
                                  startDate: loansData[key].startDate || '',
                                  nextPaymentDate: loansData[key].nextPaymentDate || '',
                                  note: loansData[key].note || '',
                                  createdAt: loansData[key].createdAt || new Date().toISOString() // Fallback
                              });
                         }
                     }
                     console.log('Loans loaded:', loans);
                     displayLoans();
                     checkAndGenerateNotifications(); // Check loan payment notifications
                     displayNotifications();
                     updateDashboardSummary(); // Update loan summary
                 }, (error) => {
                    console.error('Error loading loans:', error);
                    alert('Kredit məlumatları yüklənərkən xəta baş verdi.');
                 });


            } catch (error) {
                console.error('Error setting up data listeners:', error);
                // Generic error alert might be enough as specific ones are in 'on' callbacks
            }
        }


        // --- UI Switching & Modals ---
        function showAuthPage() {
            authPage.classList.add('active');
            mainApp.classList.remove('active');
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
             // Hide modals
             hideModals();
        }

        function showMainApp() {
            authPage.classList.remove('active');
            mainApp.classList.add('active');
             // Default to dashboard on login
             showPageSection('dashboardPage');
             // Hide forms on auth page
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
            // Set current year in settings
            settingsElements.appYear.textContent = new Date().getFullYear();
        }

        function showLoginForm() {
            loginForm.classList.add('active');
            registerForm.classList.remove('active');
        }

        function showRegisterForm() {
            loginForm.classList.remove('active');
            registerForm.classList.add('active');
        }

        function showPageSection(sectionId) {
             pageSections.forEach(section => {
                 section.classList.remove('active');
             });
             const targetSection = document.getElementById(sectionId);
             if (targetSection) {
                 targetSection.classList.add('active');
             } else {
                  console.error('Section not found:', sectionId);
                  // Default to dashboard if section not found
                  document.getElementById('dashboardPage').classList.add('active');
             }


             // Update active navbar item
             navItems.forEach(item => {
                 item.classList.remove('active');
                 if (item.getAttribute('data-section') === sectionId) {
                     item.classList.add('active');
                 }
             });

             // Hide modals when switching pages
             hideModals();
        }

        function showModal(modalElement) {
             // Add 'visible' class to trigger CSS transitions
             modalElement.classList.add('visible');
        }

         function hideModal(modalElement) {
             // Remove 'visible' class to trigger CSS transitions
             modalElement.classList.remove('visible');
         }

         function hideModals() {
              document.querySelectorAll('.modal').forEach(modal => {
                   modal.classList.remove('visible');
              });
         }


        // --- Event Listeners (UI) ---

        // Auth page button clicks
        showLoginButton.addEventListener('click', showLoginForm);
        showRegisterButton.addEventListener('click', showRegisterForm);
        switchAuthSpans.forEach(span => {
             span.addEventListener('click', (e) => {
                  if (e.target.dataset.target === 'login') showLoginForm();
                  if (e.target.dataset.target === 'register') showRegisterForm();
             });
        });

         // Password toggle icons
         passwordToggles.forEach(iconContainer => {
             iconContainer.addEventListener('click', (e) => {
                  const targetId = iconContainer.dataset.target; // Use iconContainer directly
                  const targetInput = document.getElementById(targetId);
                  const iconElement = iconContainer.querySelector('i'); // Find the icon inside

                  if (targetInput.type === 'password') {
                       targetInput.type = 'text';
                       iconElement.classList.remove('fa-eye');
                       iconElement.classList.add('fa-eye-slash');
                  } else {
                       targetInput.type = 'password';
                       iconElement.classList.remove('fa-eye-slash');
                       iconElement.classList.add('fa-eye');
                  }
             });
         });


        // Navbar clicks
         navItems.forEach(item => {
             item.addEventListener('click', (e) => {
                 e.preventDefault(); // Prevent default link behavior
                 const sectionId = item.dataset.section;
                 showPageSection(sectionId);
             });
         });

        // Show Profile Edit Modal
        headerProfilePic.addEventListener('click', () => {
             if (userProfile) {
                 // Populate the form
                 profileEditFormElements.fullName.value = userProfile.fullName || '';
                 profileEditFormElements.username.value = userProfile.username || '';
                 profileEditFormElements.birthDate.value = userProfile.birthDate || '';
                 profileEditFormElements.birthPlace.value = userProfile.birthPlace || '';
                 profileEditFormElements.gender.value = userProfile.gender || '';
                 profileEditFormElements.email.value = userProfile.email || ''; // Readonly

                 // Handle profile picture display in modal if needed
                 // The input type="file" doesn't show the current image, user selects new one

                 showModal(profileEditModal);
             } else {
                  alert('Profil məlumatları yüklənir. Zəhmət olmasa gözləyin.');
             }
        });

        // Show Notifications Modal
        showNotificationsButton.addEventListener('click', () => {
             displayNotifications(); // Re-render notifications
             showModal(notificationModal);
             // Optional: Mark notifications as read visually if needed after modal is shown
             // notificationIcon.classList.remove('hasNotifications'); // Could do this on modal open
        });

         // Show Settings Page
         showSettingsPageButton.addEventListener('click', () => {
             showPageSection('settingsPage');
         });

        // Close Modal Buttons
        closeButtons.forEach(button => {
             button.addEventListener('click', (e) => {
                 const modal = e.target.closest('.modal');
                 if (modal) {
                     hideModal(modal);
                 }
             });
        });

        // Close modal when clicking outside
         window.addEventListener('click', (event) => {
             document.querySelectorAll('.modal.visible').forEach(modal => {
                  // Check if click is outside the modal-content but inside the modal overlay
                  if (event.target === modal) {
                       hideModal(modal);
                  }
             });
         });


        // --- Firebase Authentication Actions ---

        // Register
        registerButton.addEventListener('click', async () => {
             const { fullName, username, birthDate, birthPlace, gender, profilePic, email, password, repassword } = registerFormElements;

             if (!email.value || !password.value || !fullName.value || !username.value || !birthDate.value || !birthPlace.value || !gender.value || !repassword.value) {
                 alert('Zəhmət olmasa bütün sahələri doldurun.');
                 return;
             }

             if (password.value !== repassword.value) {
                 alert('Şifrələr uyğun gəlmir!');
                 return;
             }

             if (password.value.length < 6) {
                  alert('Şifrə ən azı 6 simvol olmalıdır.');
                  return;
             }


             try {
                 // 1. Create user with email and password
                 const userCredential = await auth.createUserWithEmailAndPassword(email.value, password.value);
                 const user = userCredential.user;
                 const uid = user.uid;

                 // 2. Upload profile picture to Cloudinary
                 let profilePicUrl = '';
                 if (profilePic.files.length > 0) {
                      const uploadResult = await uploadImageToCloudinary(profilePic.files[0]);
                      if (uploadResult) {
                           profilePicUrl = uploadResult;
                      } else {
                            console.warn('Profil şəkli yüklənmədi, profilsiz davam edilir.');
                           // Optionally, you could stop registration here or prompt the user
                      }
                 }

                 // 3. Save user data to Firebase Realtime Database
                 const userData = {
                     fullName: fullName.value,
                     username: username.value,
                     birthDate: birthDate.value,
                     birthPlace: birthPlace.value,
                     gender: gender.value,
                     email: email.value,
                     profilePicUrl: profilePicUrl, // Save Cloudinary URL
                     balance: 0, // Initial balance
                     monthlyBudgetLimit: 0, // Initial limit
                     createdAt: new Date().toISOString(),
                     // Add other default settings here
                 };

                 await database.ref('users/' + uid).set(userData);

                 alert('Qeydiyyat uğurlu oldu! Zəhmət olmasa giriş edin.');
                 showLoginForm(); // Show login form after successful registration
                  // Clear registration form fields
                  for (const key in registerFormElements) {
                      if (registerFormElements[key].type !== 'file') {
                         registerFormElements[key].value = '';
                      } else {
                         registerFormElements[key].value = null; // Clear file input
                      }
                  }

             } catch (error) {
                 console.error('Registration error:', error);
                 let errorMessage = 'Qeydiyyat zamanı xəta baş verdi.';
                 if (error.code === 'auth/email-already-in-use') {
                      errorMessage = 'Bu email artıq istifadə olunur.';
                 } else if (error.code === 'auth/invalid-email') {
                      errorMessage = 'Yanlış email formatı.';
                 } else if (error.code === 'auth/weak-password') {
                     errorMessage = 'Şifrə ən azı 6 simvol olmalıdır.';
                 }
                 alert(errorMessage + "\nKod: " + error.code); // Show error code for debugging
             }
        });

        // Login
        loginButton.addEventListener('click', async () => {
             const { email, password } = loginFormElements; // Using email as per Firebase Auth

             if (!email.value || !password.value) {
                 alert('Zəhmət olmasa email və şifrəni daxil edin.');
                 return;
             }

             try {
                  // Firebase login uses email.
                 const userCredential = await auth.signInWithEmailAndPassword(email.value, password.value);
                 // onAuthStateChanged listener will handle showing the main app and loading data
                 console.log('Login successful');
                 // Clear login form fields
                 email.value = '';
                 password.value = '';

             } catch (error) {
                  console.error('Login error:', error);
                  let errorMessage = 'Giriş zamanı xəta baş verdi.';
                  if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                      errorMessage = 'Yanlış email və ya şifrə.';
                  } else if (error.code === 'auth/invalid-email') {
                      errorMessage = 'Yanlış email formatı.';
                  } else if (error.code === 'auth/invalid-credential') { // Newer Firebase versions
                      errorMessage = 'Yanlış email və ya şifrə.';
                  }
                  alert(errorMessage + "\nKod: " + error.code); // Show error code
             }
        });

         // Logout
         settingsElements.logoutButton.addEventListener('click', async () => {
             try {
                  await auth.signOut();
                  console.log('Logged out');
                  // onAuthStateChanged listener handles showing auth page
             } catch (error) {
                  console.error('Logout error:', error);
                  alert('Çıxış zamanı xəta baş verdi.' + "\nKod: " + error.code);
             }
         });


        // --- Main App Functionality ---

       // Profil Görünümünü Güncelle (Header)
function updateProfileDisplay() {
    const profileImg = headerProfilePic.querySelector('img');

    // CSS değişkenlerini al
    const rootStyles = getComputedStyle(document.documentElement);
    const borderColor = rootStyles.getPropertyValue('--border-color').trim();
    const secondaryTextColor = rootStyles.getPropertyValue('--secondary-text-color').trim();

    if (userProfile && userProfile.profilePicUrl) {
        // Profil resmi varsa, göster
        profileImg.src = userProfile.profilePicUrl;
        profileImg.style.display = 'block';
        headerProfilePic.style.backgroundColor = 'transparent'; // Yer tutucu arka planı kaldır
        headerProfilePic.innerHTML = ''; // İçeriği temizle
    } else {
        // Profil resmi yoksa, varsayılan durumu göster
        profileImg.src = '';
        profileImg.style.display = 'none';
        headerProfilePic.style.backgroundColor = borderColor; // Yer tutucu arka plan rengi
       
        // Kullanıcının adının ilk harfini göster veya varsayılan ikon
        headerProfilePic.innerHTML = userProfile?.fullName 
            ? userProfile.fullName.charAt(0).toUpperCase() 
            : '<i class="fas fa-user"></i>';

        headerProfilePic.style.fontSize = '20px';
        headerProfilePic.style.color = secondaryTextColor;
        headerProfilePic.style.display = 'flex';
        headerProfilePic.style.alignItems = 'center';
        headerProfilePic.style.justifyContent = 'center';
    }
}


        // Save Profile Edits
        saveProfileButton.addEventListener('click', async () => {
             if (!currentUser || !userProfile) return;

             const { fullName, username, birthDate, birthPlace, gender, profilePic } = profileEditFormElements;
             const uid = currentUser.uid;

             // 1. Upload new profile picture if selected
             let profilePicUrl = userProfile.profilePicUrl || ''; // Keep existing URL if no new file
             if (profilePic.files.length > 0) {
                 const uploadResult = await uploadImageToCloudinary(profilePic.files[0]);
                  if (uploadResult) {
                       profilePicUrl = uploadResult;
                  } else {
                        console.warn('Yeni profil şəkli yüklənmədi.');
                       // profilePicUrl remains the old one or empty
                        alert('Yeni profil şəkli yüklənərkən xəta baş verdi. Profil digər məlumatlarla yeniləndi.');
                  }
             }

             // 2. Update user data in Firebase
             const updatedData = {
                 fullName: fullName.value,
                 username: username.value,
                 birthDate: birthDate.value,
                 birthPlace: birthPlace.value,
                 gender: gender.value,
                 profilePicUrl: profilePicUrl, // Save new (or old) Cloudinary URL
                 // email is readonly, don't update here
             };

             try {
                  await database.ref('users/' + uid).update(updatedData);
                  alert('Profil uğurla yeniləndi.');
                  hideModal(profileEditModal);
                   // The 'on' listener for userProfile will automatically update the display
             } catch (error) {
                  console.error('Error updating profile:', error);
                   alert('Profil yenilənərkən xəta baş verdi.' + "\nKod: " + error.code);
             }
        });


        // --- Dashboard Display ---
        function updateDashboardSummary() {
             if (!userProfile) {
                  balanceSummaryDiv.innerHTML = '<p>Balans məlumatları yüklənir...</p>';
                  loanSummaryDiv.innerHTML = '<p>Kredit məlumatları yüklənir...</p>';
                  settingsElements.currentBudgetRemaining.textContent = '-';
                  return;
             }

             const currentBalance = userProfile.balance || 0;
             const monthlyBudgetLimit = userProfile.monthlyBudgetLimit || 0;

             // Calculate monthly spending for current month
             const now = new Date();
             const currentMonth = now.getMonth();
             const currentYear = now.getFullYear();

             const monthlySpending = expenses
                 .filter(exp => {
                      const expDate = new Date(exp.date);
                      return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
                 })
                 .reduce((sum, exp) => sum + exp.amount, 0);

             const budgetRemaining = monthlyBudgetLimit > 0 ? monthlyBudgetLimit - monthlySpending : 'Limit qoyulmayıb';


             balanceSummaryDiv.innerHTML = `
                 <h3>Balans & Büdcə</h3>
                 <p>Cari Balans: <strong>${currentBalance.toFixed(2)} AZN</strong></p>
                 <p>Aylıq Büdcə Limiti: <strong>${monthlyBudgetLimit > 0 ? monthlyBudgetLimit.toFixed(2) + ' AZN' : 'Qoyulmayıb'}</strong></p>
                 <p>Cari Ayın Xərci: <strong>${monthlySpending.toFixed(2)} AZN</strong></p>
                 <p>Büdcə Qalıqı: <strong>${typeof budgetRemaining === 'number' ? budgetRemaining.toFixed(2) + ' AZN' : budgetRemaining}</strong></p>
             `;

             // Loan Summary
             let nextLoanPaymentInfo = 'Yaxınlaşan kredit ödənişi yoxdur.';
             if (loans.length > 0) {
                  // Find the soonest next payment date that is today or in the future
                  const upcomingLoans = loans
                      .filter(loan => loan.nextPaymentDate && new Date(loan.nextPaymentDate) >= new Date(now.toDateString())) // Compare dates only
                      .sort((a, b) => new Date(a.nextPaymentDate) - new Date(b.nextPaymentDate));

                  if (upcomingLoans.length > 0) {
                       const nextLoan = upcomingLoans[0];
                       nextLoanPaymentInfo = `Yaxınlaşan Ödəniş: <strong>${nextLoan.name}</strong> (${nextLoan.monthlyPayment.toFixed(2)} AZN) - ${new Date(nextLoan.nextPaymentDate).toLocaleDateString('az-AZ')}`;
                  } else {
                       // Check for overdue loans if no future ones
                       const overdueLoans = loans
                            .filter(loan => loan.nextPaymentDate && new Date(loan.nextPaymentDate) < new Date(now.toDateString()))
                            .sort((a, b) => new Date(b.nextPaymentDate) - new Date(a.nextPaymentDate)); // Show latest overdue first
                        if (overdueLoans.length > 0) {
                             const latestOverdue = overdueLoans[0];
                             nextLoanPaymentInfo = `<span style="color: var(--danger-color);">Son Ödəniş Keçib: <strong>${latestOverdue.name}</strong> (${latestOverdue.monthlyPayment.toFixed(2)} AZN) - ${new Date(latestOverdue.nextPaymentDate).toLocaleDateString('az-AZ')}</span>`;
                        } else {
                             nextLoanPaymentInfo = 'Gələcək kredit ödənişi yoxdur.'; // No future or overdue loans found
                        }
                  }
             }

             loanSummaryDiv.innerHTML = `
                 <h3>Kreditlər</h3>
                 <p>${nextLoanPaymentInfo}</p>
                 <p>Ümumi Kredit Sayı: ${loans.length}</p>
             `;

             // Update settings page budget remaining display
             if (typeof budgetRemaining === 'number') {
                  settingsElements.currentBudgetRemaining.textContent = budgetRemaining.toFixed(2);
             } else {
                  settingsElements.currentBudgetRemaining.textContent = budgetRemaining;
             }

        }

        function displayExpenses() {
             expenseListDiv.innerHTML = ''; // Clear current list

             if (expenses.length === 0) {
                  expenseListDiv.innerHTML = '<p>Hələ heç bir xərc əlavə olunmayıb.</p>';
                  return;
             }

             // Sort expenses by date descending
             expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

             // Display only the last 10 expenses on dashboard for summary
             const recentExpenses = expenses.slice(0, 10);


             recentExpenses.forEach(exp => {
                  const expenseItem = document.createElement('div');
                  expenseItem.classList.add('expenseItem');
                  expenseItem.dataset.expenseId = exp.id;

                  // Basic category mapping (replace with dynamic lookup if needed)
                  const categoryMap = {
                      food: 'Qida',
                      transport: 'Nəqliyyat',
                      shopping: 'Alış-veriş',
                      utilities: 'Kommunal',
                      health: 'Sağlamlıq',
                      entertainment: 'Əyləncə',
                      other: 'Digər'
                  };
                  const displayCategory = categoryMap[exp.category] || exp.category || 'Naməlum Kateqoriya';


                  expenseItem.innerHTML = `
                      <div class="details">
                          <h3>${displayCategory}</h3>
                          <p>${exp.date} - ${exp.note || ''}</p>
                      </div>
                      <div class="amount">- ${exp.amount.toFixed(2)} AZN</div>
                  `;

                  expenseItem.addEventListener('click', () => {
                       showExpenseDetails(exp.id); // Function to show details
                  });

                  expenseListDiv.appendChild(expenseItem);
             });
             // Add a link or button to view all expenses if there are more than 10
             if (expenses.length > 10) {
                 const viewAllLink = document.createElement('p');
                 viewAllLink.innerHTML = '<a href="#" id="viewAllExpensesLink">Bütün xərclərə bax</a>';
                 viewAllLink.style.textAlign = 'center';
                 viewAllLink.style.marginTop = '15px';
                 expenseListDiv.appendChild(viewAllLink);

                 viewAllLink.querySelector('a').addEventListener('click', (e) => {
                     e.preventDefault();
                     // TODO: Implement a dedicated "All Expenses" page or expand the list
                     alert('Bütün xərclərin siyahısı funksiyası hələ tətbiq olunmayıb. Cari siyahı son 10 xərci göstərir.');
                     // A real implementation would likely switch to a different page section displaying all expenses
                     // For this single-file example, just noting it.
                 });
             }
        }

         function showExpenseDetails(expenseId) {
              const expense = expenses.find(exp => exp.id === expenseId);

              if (!expense) {
                   expenseDetailsElements.contentDiv.innerHTML = '<p>Xərc tapılmadı.</p>';
                   expenseDetailsElements.editButton.style.display = 'none';
                   expenseDetailsElements.deleteButton.style.display = 'none';
                   showPageSection('expenseDetailsPage');
                   return;
              }

              const categoryMap = {
                  food: 'Qida',
                  transport: 'Nəqliyyat',
                  shopping: 'Alış-veriş',
                  utilities: 'Kommunal',
                  health: 'Sağlamlıq',
                  entertainment: 'Əyləncə',
                  other: 'Digər'
              };
              const displayCategory = categoryMap[expense.category] || expense.category || 'Naməlum Kateqoriya';


              expenseDetailsElements.contentDiv.innerHTML = `
                   <p><strong>Kateqoriya:</strong> ${displayCategory}</p>
                   <p><strong>Məbləğ:</strong> ${expense.amount.toFixed(2)} AZN</p>
                   <p><strong>Tarix:</strong> ${expense.date}</p>
                   <p><strong>Qeyd:</strong> ${expense.note || '-'}</p>
                   `;

              // Set up Edit/Delete buttons (need event listeners and logic)
              expenseDetailsElements.editButton.style.display = 'inline-block';
              expenseDetailsElements.deleteButton.style.display = 'inline-block';


              expenseDetailsElements.editButton.onclick = () => editExpense(expense.id);
              expenseDetailsElements.deleteButton.onclick = () => deleteExpense(expense.id);


              showPageSection('expenseDetailsPage');
         }

         // Placeholder for Edit Expense function
         function editExpense(expenseId) {
             console.log('Edit expense:', expenseId);
             // TODO: Implement edit functionality (e.g., pre-fill add form, change button to update)
              const expenseToEdit = expenses.find(exp => exp.id === expenseId);
              if (expenseToEdit) {
                  // Example: Populate Add Expense form with data for editing
                  addExpenseFormElements.amount.value = expenseToEdit.amount;
                  addExpenseFormElements.date.value = expenseToEdit.date;
                  addExpenseFormElements.category.value = expenseToEdit.category;
                  addExpenseFormElements.note.value = expenseToEdit.note;
                  // Change the save button's behavior or show a specific "Update Expense" button
                  saveExpenseButton.textContent = 'Xərci Yenilə'; // Change button text
                  saveExpenseButton.dataset.editId = expenseId; // Store ID being edited

                  showPageSection('addExpensePage'); // Navigate to the Add Expense form

                  // Add a click handler for the updated button
                   saveExpenseButton.onclick = async () => {
                       await updateExpense(expenseId);
                   };

              } else {
                  alert('Redaktə ediləcək xərc tapılmadı.');
              }
         }

         // Update Expense (called by modified save button)
         async function updateExpense(expenseId) {
              if (!currentUser) return;

              const { amount, date, category, note } = addExpenseFormElements;

               const updatedData = {
                   amount: parseFloat(amount.value),
                   date: date.value,
                   category: category.value,
                   note: note.value,
               };

              // Basic validation
              if (isNaN(updatedData.amount) || updatedData.amount <= 0 || !updatedData.date || !updatedData.category) {
                   alert('Zəhmət olmasa məbləğ, tarix və kateqoriyanı daxil edin.');
                   return;
              }

              try {
                   await database.ref('expenses/' + currentUser.uid + '/' + expenseId).update(updatedData);
                   alert('Xərc uğurla yeniləndi.');

                   // Reset form and button
                   amount.value = '';
                   date.value = '';
                   category.value = '';
                   note.value = '';
                   saveExpenseButton.textContent = 'Xərci Yadda Saxla'; // Reset button text
                   delete saveExpenseButton.dataset.editId; // Remove edit ID
                    // Reset click handler back to adding
                   saveExpenseButton.onclick = async () => {
                       await saveNewExpense(); // Use a separate function for adding
                   };

                   showPageSection('dashboardPage'); // Go back to dashboard/list
                    // The 'on' listener will update the list automatically
              } catch (error) {
                   console.error('Error updating expense:', error);
                   alert('Xərc yenilənərkən xəta baş verdi.' + "\nKod: " + error.code);
              }
         }

         // Separate function for saving a *new* expense
         async function saveNewExpense() {
              if (!currentUser) return;

              const { amount, date, category, note } = addExpenseFormElements;

              const expenseData = {
                   amount: parseFloat(amount.value),
                   date: date.value,
                   category: category.value,
                   note: note.value,
                   createdAt: new Date().toISOString()
              };

              // Basic validation
              if (isNaN(expenseData.amount) || expenseData.amount <= 0 || !expenseData.date || !expenseData.category) {
                   alert('Zəhmət olmasa məbləğ, tarix və kateqoriyanı daxil edin.');
                   return;
              }

              try {
                   await database.ref('expenses/' + currentUser.uid).push(expenseData);
                   alert('Xərc uğurla əlavə edildi.');

                   // Clear form
                   amount.value = '';
                   date.value = '';
                   category.value = '';
                   note.value = '';

                   showPageSection('dashboardPage'); // Go back to dashboard/list
                   // The 'on' listener will update the list automatically
              } catch (error) {
                   console.error('Error adding expense:', error);
                   alert('Xərc əlavə edilərkən xəta baş verdi.' + "\nKod: " + error.code);
              }
         }
         // Initial click handler for the save button should be saveNewExpense
          saveExpenseButton.onclick = async () => {
               await saveNewExpense();
           };


         async function deleteExpense(expenseId) {
              if (!currentUser) return;

              if (confirm('Bu xərci silmək istədiyinizə əminsinizmi?')) {
                   try {
                       await database.ref('expenses/' + currentUser.uid + '/' + expenseId).remove();
                       console.log('Expense deleted:', expenseId);
                       // UI will update automatically due to 'on' listener
                       alert('Xərc uğurla silindi.');
                        showPageSection('dashboardPage'); // Go back to list after deleting
                   } catch (error) {
                       console.error('Error deleting expense:', error);
                        alert('Xərc silinərkən xəta baş verdi.' + "\nKod: " + error.code);
                   }
              }
         }


         // --- Loan Functionality ---

         addLoanButton.addEventListener('click', () => {
              // Clear loan modal form before showing
              addLoanModalElements.name.value = '';
              addLoanModalElements.totalAmount.value = '';
              addLoanModalElements.monthlyPayment.value = '';
              addLoanModalElements.startDate.value = '';
              addLoanModalElements.nextPaymentDate.value = '';
              addLoanModalElements.note.value = '';
              addLoanModalElements.saveButton.textContent = 'Krediti Yadda Saxla'; // Reset button text
              addLoanModalElements.saveButton.dataset.editId = ''; // Clear edit ID

              // Set click handler for adding a new loan
              addLoanModalElements.saveButton.onclick = async () => {
                  await saveNewLoan();
              }

              showModal(addLoanModalElements.modal);
         });

         // Save New Loan
         async function saveNewLoan() {
              if (!currentUser) return;

              const { name, totalAmount, monthlyPayment, startDate, nextPaymentDate, note } = addLoanModalElements;

              const loanData = {
                   name: name.value,
                   totalAmount: parseFloat(totalAmount.value),
                   monthlyPayment: parseFloat(monthlyPayment.value),
                   startDate: startDate.value,
                   nextPaymentDate: nextPaymentDate.value,
                   note: note.value,
                   createdAt: new Date().toISOString()
              };

              // Basic validation
              if (!loanData.name || isNaN(loanData.totalAmount) || loanData.totalAmount <= 0 || isNaN(loanData.monthlyPayment) || loanData.monthlyPayment <= 0 || !loanData.startDate || !loanData.nextPaymentDate) {
                   alert('Zəhmət olmasa bütün vacib sahələri (Ad, Ümumi Məbləğ, Aylıq Ödəniş, Başlanğıc Tarixi, Növbəti Ödəniş Tarixi) doldurun.');
                   return;
              }

              try {
                   await database.ref('loans/' + currentUser.uid).push(loanData);
                   alert('Kredit uğurla əlavə edildi.');

                   // Clear form handled before showing modal
                   hideModal(addLoanModalElements.modal);
                   // 'on' listener will update loan list
              } catch (error) {
                   console.error('Error adding loan:', error);
                   alert('Kredit əlavə edilərkən xəta baş verdi.' + "\nKod: " + error.code);
              }
         }

         // Display Loans
         function displayLoans() {
             loanListDiv.innerHTML = ''; // Clear current list

             if (loans.length === 0) {
                  loanListDiv.innerHTML = '<p>Hələ heç bir kredit əlavə olunmayıb.</p>';
                  return;
             }

             // Sort loans by next payment date ascending
             loans.sort((a, b) => new Date(a.nextPaymentDate) - new Date(b.nextPaymentDate));

             loans.forEach(loan => {
                  const loanItem = document.createElement('div');
                  loanItem.classList.add('loanItem');
                  loanItem.dataset.loanId = loan.id;

                  const startDate = new Date(loan.startDate);
                  const now = new Date();
                  // Calculate months passed (approximate)
                  const monthsPassed = calculateMonthsPassed(startDate);
                  const remainingAmount = Math.max(0, loan.totalAmount - (loan.monthlyPayment * monthsPassed)); // Basic calculation
                  const remainingDisplay = remainingAmount > 0 ? remainingAmount.toFixed(2) + ' AZN' : 'Tam ödənilib';

                  const nextPaymentDateObj = new Date(loan.nextPaymentDate);
                  const nextPaymentDateDisplay = nextPaymentDateObj.toLocaleDateString('az-AZ');

                  // Highlight if overdue
                  let dateClass = '';
                   if (nextPaymentDateObj < new Date(now.toDateString())) {
                       dateClass = 'overdue'; // Add CSS class for overdue
                   } else if (nextPaymentDateObj <= new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000)) { // Within next 7 days
                       dateClass = 'due-soon'; // Add CSS class for due soon
                   }


                  loanItem.innerHTML = `
                      <div class="details">
                          <h3>${loan.name}</h3>
                           <p>Qalan Məbləğ: ${remainingDisplay}</p>
                          <p class="${dateClass}">Növbəti Ödəniş Tarixi: <strong>${nextPaymentDateDisplay}</strong></p>
                           ${loan.note ? `<p>Qeyd: ${loan.note}</p>` : ''}
                      </div>
                      <div class="amount">Aylıq: ${loan.monthlyPayment.toFixed(2)} AZN</div>
                  `;
                   // Add CSS for .loanItem p.overdue { color: var(--danger-color); font-weight: bold; }
                   // Add CSS for .loanItem p.due-soon { color: var(--warn-color); }


                   loanItem.addEventListener('click', () => {
                       // TODO: Implement loan details/edit modal/page
                       alert('Kredit detalları/redaktə funksiyası hələ tətbiq olunmayıb. Kredit ID: ' + loan.id);
                   });

                  loanListDiv.appendChild(loanItem);
             });
         }

         // Helper to calculate approximate months passed
         function calculateMonthsPassed(startDate) {
              const now = new Date();
              const startYear = startDate.getFullYear();
              const startMonth = startDate.getMonth();
              const nowYear = now.getFullYear();
              const nowMonth = now.getMonth();

              let months = (nowYear - startYear) * 12 + (nowMonth - startMonth);

               // Adjust if current day is before the start day in the current month
               if (now.getDate() < startDate.getDate()) {
                   months--;
               }

               return Math.max(0, months); // Don't return negative months
         }


         // --- Settings Functionality ---

         // Update Settings Page Display (Initial load and on userProfile change)
         function updateSettingsDisplay() {
              if (userProfile) {
                   settingsElements.currentBalance.value = (userProfile.balance || 0).toFixed(2);
                   settingsElements.monthlyBudgetLimit.value = userProfile.monthlyBudgetLimit || 0;
                   // Budget remaining is updated in updateDashboardSummary
              }
         }

         // Add Balance
         settingsElements.addBalanceButton.addEventListener('click', async () => {
              if (!currentUser || !userProfile) return;

              const amountToAdd = parseFloat(settingsElements.addBalanceAmount.value);

              if (isNaN(amountToAdd) || amountToAdd <= 0) {
                   alert('Zəhmət olmasa müsbət bir məbləğ daxil edin.');
                   return;
              }

              const newBalance = (userProfile.balance || 0) + amountToAdd;

              try {
                   await database.ref('users/' + currentUser.uid).update({ balance: newBalance });
                   alert('Balans uğurla artırıldı.');
                   settingsElements.addBalanceAmount.value = ''; // Clear input
                   // 'on' listener will update display
              } catch (error) {
                   console.error('Error adding balance:', error);
                   alert('Balans artırılarkən xəta baş verdi.' + "\nKod: " + error.code);
              }
         });

          // Save Budget Limit
          settingsElements.saveBudgetLimit.addEventListener('click', async () => {
              if (!currentUser) return;

               const newLimit = parseFloat(settingsElements.monthlyBudgetLimit.value);

                if (isNaN(newLimit) || newLimit < 0) {
                   alert('Zəhmət olmasa müsbət və ya sıfır bir limit daxil edin.');
                    return;
                }

               try {
                    await database.ref('users/' + currentUser.uid).update({ monthlyBudgetLimit: newLimit });
                    alert('Büdcə limiti uğurla yadda saxlandı.');
                    // 'on' listener will update display and check notifications
               } catch (error) {
                    console.error('Error saving budget limit:', error);
                     alert('Büdcə limiti yadda saxlanılarkən xəta baş verdi.' + "\nKod: " + error.code);
               }
          });


         // Change Password
         settingsElements.changePasswordButton.addEventListener('click', async () => {
               if (!currentUser || !currentUser.email) return; // Need email for reauthentication

               const currentPassword = settingsElements.currentPassword.value;
               const newPassword = settingsElements.newPassword.value;
               const confirmNewPassword = settingsElements.confirmNewPassword.value;

               if (!currentPassword || !newPassword || !confirmNewPassword) {
                    alert('Zəhmət olmasa bütün şifrə sahələrini doldurun.');
                    return;
               }

                if (newPassword !== confirmNewPassword) {
                    alert('Yeni şifrələr uyğun gəlmir.');
                    return;
                }

                if (newPassword.length < 6) {
                    alert('Yeni şifrə ən azı 6 simvol olmalıdır.');
                     return;
                }

               try {
                    // Re-authenticate the user before changing password
                    const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
                    await currentUser.reauthenticateWithCredential(credential);

                    // Change password
                    await currentUser.updatePassword(newPassword);

                    alert('Şifrə uğurla dəyişdirildi.');
                    // Clear password fields
                    settingsElements.currentPassword.value = '';
                    settingsElements.newPassword.value = '';
                    settingsElements.confirmNewPassword.value = '';
               } catch (error) {
                    console.error('Error changing password:', error);
                    let errorMessage = 'Şifrə dəyişdirilərkən xəta baş verdi.';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Cari şifrə yanlışdır.';
                    } else if (error.code === 'auth/weak-password') {
                         errorMessage = 'Yeni şifrə zəifdir (ən azı 6 simvol).';
                    } else if (error.code === 'auth/requires-recent-login') {
                        errorMessage = 'Bu əməliyyat üçün yenidən giriş etməyiniz tələb olunur. Zəhmət olmasa çıxış edib yenidən giriş edin və cəhd edin.';
                    }
                    alert(errorMessage + "\nKod: " + error.code);
               }
         });


         // --- Notifications ---
          // This function checks conditions and populates the 'notifications' array
          function checkAndGenerateNotifications() {
               const currentNotifications = []; // Use a temp array

               // 1. Budget Limit Notification
               const monthlyBudgetLimit = userProfile?.monthlyBudgetLimit || 0;
               if (monthlyBudgetLimit > 0) {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    const monthlySpending = expenses
                         .filter(exp => {
                              const expDate = new Date(exp.date);
                               // Check if date is valid before accessing getMonth/getFullYear
                              return !isNaN(expDate.getTime()) && expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
                         })
                        .reduce((sum, exp) => sum + exp.amount, 0);

                    const usagePercentage = monthlyBudgetLimit > 0 ? (monthlySpending / monthlyBudgetLimit) * 100 : 0;

                    // Notify at 80% and 100%+ threshold
                    if (usagePercentage >= 100) {
                         currentNotifications.push({ type: 'budget', message: `Aylıq büdcə limitiniz (<strong>${monthlyBudgetLimit.toFixed(2)} AZN</strong>) keçildi! Cari xərc: ${monthlySpending.toFixed(2)} AZN.`, timestamp: new Date() });
                    } else if (usagePercentage >= 80) {
                         currentNotifications.push({ type: 'budget', message: `Aylıq büdcənizin <strong>${usagePercentage.toFixed(0)}%</strong>-i istifadə olundu. Cari xərc: ${monthlySpending.toFixed(2)} AZN.`, timestamp: new Date() });
                    }
               }

                // 2. Loan Payment Due Notification
                 const now = new Date();
                loans.forEach(loan => {
                    if (loan.nextPaymentDate) {
                         const nextPaymentDate = new Date(loan.nextPaymentDate);
                         // Check if date is valid
                         if (!isNaN(nextPaymentDate.getTime())) {
                              const timeDiff = nextPaymentDate.getTime() - now.getTime();
                              const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)); // Days difference

                              // Notify if due in the next 7 days or is overdue
                              if (daysDiff >= -30 && daysDiff <= 7) { // Notify for dates up to 30 days in the past
                                  let message = `<strong>${loan.name}</strong> kreditinin növbəti ödənişi ${new Date(loan.nextPaymentDate).toLocaleDateString('az-AZ')} tarixinə (<strong>${loan.monthlyPayment.toFixed(2)} AZN</strong>) yaxınlaşır.`;
                                   if (daysDiff === 0) {
                                       message = `<strong>${loan.name}</strong> kreditinin ödənişi bu gün (${new Date(loan.nextPaymentDate).toLocaleDateString('az-AZ')})dir! Məbləğ: <strong>${loan.monthlyPayment.toFixed(2)} AZN</strong>.`;
                                   } else if (daysDiff < 0) {
                                        const overdueDays = Math.abs(daysDiff);
                                        message = `<span style="color: var(--danger-color);"><strong>${loan.name}</strong> kreditinin ödəniş tarixi (${new Date(loan.nextPaymentDate).toLocaleDateString('az-AZ')}) <strong>${overdueDays} gün</strong> keçib! Məbləğ: <strong>${loan.monthlyPayment.toFixed(2)} AZN</strong>.</span>`;
                                   } else if (daysDiff === 1) {
                                       message = `<strong>${loan.name}</strong> kreditinin növbəti ödənişi sabah (${new Date(loan.nextPaymentDate).toLocaleDateString('az-AZ')})dır! Məbləğ: <strong>${loan.monthlyPayment.toFixed(2)} AZN</strong>.`;
                                   }
                                   currentNotifications.push({ type: 'loan', message: message, timestamp: new Date() }); // Use current time for notification creation time
                             }
                         }
                    }
                });

               // Update the global notifications array and sort
                notifications = currentNotifications.sort((a, b) => b.timestamp - a.timestamp);


               // Update notification icon appearance
               if (notifications.length > 0) {
                    notificationIcon.classList.add('hasNotifications');
               } else {
                    notificationIcon.classList.remove('hasNotifications');
               }
          }

          // This function displays the notifications currently in the 'notifications' array
          function displayNotifications() {
               notificationListDiv.innerHTML = ''; // Clear current list

               if (notifications.length === 0) {
                    notificationListDiv.innerHTML = '<p>Bildiriş yoxdur.</p>';
                    return;
               }

               notifications.forEach(notif => {
                    const notifItem = document.createElement('div');
                    notifItem.classList.add('notificationItem');
                    // Add class based on type for potential specific styling
                    if (notif.type) notifItem.classList.add(notif.type + '-notification');


                    const timeAgo = formatTimeAgo(notif.timestamp); // Helper function needed

                    notifItem.innerHTML = `
                        <p>${notif.message}</p>
                        <span class="notificationTime">${timeAgo}</span>
                    `;

                    notificationListDiv.appendChild(notifItem);
               });
          }

          // Helper function to format time ago
          function formatTimeAgo(timestamp) {
              const now = new Date();
              const date = new Date(timestamp);
              const seconds = Math.floor((now - date) / 1000);

              // Show full date if more than 1 day ago
              if (seconds > 86400) {
                  // Check if it was yesterday
                   const yesterday = new Date(now);
                   yesterday.setDate(now.getDate() - 1);
                   if (date.toDateString() === yesterday.toDateString()) {
                       return "Dünən " + date.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });
                   }
                   // Show full date for older
                   return date.toLocaleDateString('az-AZ'); // Format as dd.mm.yyyy
              }


              let interval = Math.floor(seconds / 3600);
              if (interval >= 1) return interval + " saat əvvəl";

              interval = Math.floor(seconds / 60);
              if (interval >= 1) return interval + " dəqiqə əvvəl";

              return "İndi"; // Or "Bir neçə saniyə əvvəl"
          }


          // --- Reporting (PDF/Excel) ---
          // Requires external libraries (jsPDF, SheetJS/xlsx) or server-side processing.
          // Implementing them purely in client-side JS in a single file is complex.
          // Provide placeholders and mention the need for libraries.

          document.getElementById('exportPdf').addEventListener('click', () => {
               // TODO: Implement PDF export
               alert('PDF ixrac funksiyası hələ tətbiq olunmayıb. Bunun üçün JS kitabxanalarına ehtiyac var (məsələn, jsPDF).');
          });

          document.getElementById('exportExcel').addEventListener('click', () => {
              // TODO: Implement Excel export
               alert('Excel ixrac funksiyası hələ tətbiq olunmayıb. Bunun üçün JS kitabxanalarına ehtiyac var (məsələn, SheetJS/xlsx).');
          });


        // --- Initial Setup ---
         // Set the initial view based on authentication state
        // The auth.onAuthStateChanged listener handles showing the correct initial view automatically.
        // Just need to make sure the initial state is handled.
        // Show auth page initially, listener will switch if already logged in.
        showAuthPage();


    </script>

</body>
</html>

